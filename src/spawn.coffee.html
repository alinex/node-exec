<!DOCTYPE html>
<html>
<head>
  <title>spawn.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = "../";
    var thisFile = "src/spawn.coffee";
    var defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>

<meta name="viewport" content="width=device-width, initial-scale=1.0" /></head>
<body>
  <nav>
<div class="logo"><a href="http://alinex.github.io"
  onmouseover="logo.src='https://alinex.github.io/images/Alinex-200.png'"
  onmouseout="logo.src='https://alinex.github.io/images/Alinex-black-200.png'">
  <img name="logo" src="https://alinex.github.io/images/Alinex-black-200.png"
    width="150" title="Alinex Universe Homepage" />
  </a>
  <img src="http://alinex.github.io/images/Alinex-200.png"
    style="display:none" alt="preloading" />
</div>
<div class="links">
  <a href="http://alinex.github.io/blog"
    class="btn btn-primary"><span class="glyphicon-pencil"></span> Blog</a>
  <a href="http://alinex.github.io/develop"
    class="btn btn-primary"><span class="glyphicon-book"></span> Develop</a>
  <a href="http://alinex.github.io/code.html"
    class="btn btn-warning"><span class="glyphicon-cog"></span> Code</a>
</div>
</nav><div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

      <div class="heading h1">
        <a href="#local-execution-using-spawn">Local execution using spawn</a>
      </div>

      <div class="heading h2">
        <a href="#node-modules">Node Modules</a>
      </div>

      <div class="heading h2">
        <a href="#configuration">Configuration</a>
      </div>

      <div class="heading h2">
        <a href="#run-local-command">Run local command</a>
      </div>

      <div class="heading h2">
        <a href="#check-vital-signs">Check vital signs</a>
      </div>

      <div class="heading h3">
        <a href="#measure-cpu-usage">Measure CPU usage</a>
      </div>

      <div class="heading h2">
        <a href="#export-public-methods">Export public methods</a>
      </div>

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container" tabindex="0"><a id="fork" href="https://github.com/alinex/node-exec" title="Fork me on GitHub"></a>
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="local-execution-using-spawn">
  <h1>
    <a href="#local-execution-using-spawn" name="local-execution-using-spawn" class="pilcrow"></a>
Local execution using spawn
  </h1>
</div>
<p>This is an object oriented implementation around the core <code>process.spawn</code>
command and alternatively ssh connections.</p>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="node-modules">
  <h2>
    <a href="#node-modules" name="node-modules" class="pilcrow"></a>
Node Modules
  </h2>
</div>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>include base modules</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">debug = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'exec:spawn'</span>)
debugCmd = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'exec:cmd'</span>)
debugOut = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'exec:out'</span>)
debugErr = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'exec:err'</span>)
chalk = <span class="hljs-built_in">require</span> <span class="hljs-string">'chalk'</span>
{spawn} = <span class="hljs-built_in">require</span> <span class="hljs-string">'child_process'</span>
os = <span class="hljs-built_in">require</span> <span class="hljs-string">'os'</span>
carrier = <span class="hljs-built_in">require</span> <span class="hljs-string">'carrier'</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>include alinex modules</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">util = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-util'</span>
config = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-config'</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>include helper classes</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">helper = <span class="hljs-built_in">require</span> <span class="hljs-string">'./helper'</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="configuration">
  <h2>
    <a href="#configuration" name="configuration" class="pilcrow"></a>
Configuration
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">MEASURE_TIME = <span class="hljs-number">1000</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="run-local-command">
  <h2>
    <a href="#run-local-command" name="run-local-command" class="pilcrow"></a>
Run local command
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">run</span> = <span class="hljs-params">(cb)</span> -&gt;</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>set command</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  cmd = @setup.cmd
  args = <span class="hljs-keyword">if</span> @setup.args <span class="hljs-keyword">then</span> @setup.args[<span class="hljs-number">0.</span>.] <span class="hljs-keyword">else</span> []</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>support priority based nice values</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  prio = @conf.priority.level[@setup.priority]
  <span class="hljs-keyword">if</span> prio.nice <span class="hljs-keyword">and</span> process.platform <span class="hljs-keyword">is</span> <span class="hljs-string">'linux'</span>
    <span class="hljs-keyword">if</span> prio.nice &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> (@setup.uid <span class="hljs-keyword">is</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> (<span class="hljs-keyword">not</span> @setup.uid? <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> process.getuid()))</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>add support for nice call</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      args.unshift <span class="hljs-string">'-n'</span>, prio.nice, cmd <span class="hljs-comment"># nice setting, command</span>
      cmd = <span class="hljs-string">'nice'</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>set environment to english language</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  env = @setup.env ? util.extend <span class="hljs-string">'MODE CLONE'</span>, process.env,
    LANG: <span class="hljs-string">'C'</span>
    LC_ALL: <span class="hljs-string">'C'</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>store process information</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  @process =
    host: <span class="hljs-string">'localhost'</span>
    start: <span class="hljs-keyword">new</span> Date()</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>start process</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-keyword">try</span>
    @proc = spawn cmd, args,
      env: env
      cwd: @setup.cwd</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<pre><code> uid: @setup.uid
 gid: @setup.gid
</code></pre>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      timeout: @setup.timeout
      killSignal: <span class="hljs-string">'SIGKILL'</span>
  <span class="hljs-keyword">catch</span> error
    <span class="hljs-keyword">if</span> error.message <span class="hljs-keyword">is</span> <span class="hljs-string">'spawn EMFILE'</span>
      interval = @conf.retry.ulimit.interval
      debug chalk.grey <span class="hljs-string">"<span class="hljs-subst">#{@name}</span> too much processes are opened, waiting
</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>{interval} ms...&quot;</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      @emit <span class="hljs-string">'wait'</span>, interval
      <span class="hljs-keyword">return</span> setTimeout (<span class="hljs-function">=&gt;</span> run.call <span class="hljs-keyword">this</span>, cb), interval
    <span class="hljs-keyword">throw</span> error</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>output debug lines</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  debug <span class="hljs-string">"<span class="hljs-subst">#{@name}</span> start using spawn under pid <span class="hljs-subst">#{@proc.pid}</span>"</span>
  @process.pid = @proc.pid
  debugCmd chalk.yellow <span class="hljs-string">"<span class="hljs-subst">#{@name}</span> <span class="hljs-subst">#{helper.cmdline @setup}</span>"</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>collect output</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  @result = {}
  @result.lines = []
  carrier.carry @proc.stdout, <span class="hljs-function"><span class="hljs-params">(line)</span> =&gt;</span>
    @result.lines.push [<span class="hljs-number">1</span>, line]
    @emit <span class="hljs-string">'stdout'</span>, line <span class="hljs-keyword">if</span> line <span class="hljs-comment"># send through</span>
    debugOut <span class="hljs-string">"<span class="hljs-subst">#{@name}</span> <span class="hljs-subst">#{line}</span>"</span>
  , <span class="hljs-string">'utf-8'</span>, <span class="hljs-regexp">/\r?\n|\r(?!\n)/</span> <span class="hljs-comment"># match also single \r</span>
  carrier.carry @proc.stderr, <span class="hljs-function"><span class="hljs-params">(line)</span> =&gt;</span>
    @result.lines.push [<span class="hljs-number">2</span>, line]
    @emit <span class="hljs-string">'stderr'</span>, line <span class="hljs-keyword">if</span> line <span class="hljs-comment"># send through</span>
    debugErr <span class="hljs-string">"<span class="hljs-subst">#{@name}</span> <span class="hljs-subst">#{line}</span>"</span>
  , <span class="hljs-string">'utf-8'</span>, <span class="hljs-regexp">/\r?\n|\r(?!\n)/</span> <span class="hljs-comment"># match also single \r</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>error management</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  @proc.<span class="hljs-literal">on</span> <span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-params">(err)</span> =&gt;</span>
    @process.error = err</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>process finished</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  @proc.<span class="hljs-literal">on</span> <span class="hljs-string">'close'</span>, <span class="hljs-function"><span class="hljs-params">(code, signal)</span> =&gt;</span>
    clearTimeout @timer <span class="hljs-keyword">if</span> @prockill?
    @result.code = code
    @process.end = <span class="hljs-keyword">new</span> Date()
    <span class="hljs-keyword">if</span> signal?
      @process.error = <span class="hljs-keyword">new</span> Error <span class="hljs-string">"<span class="hljs-subst">#{@name}</span> exit: signal <span class="hljs-subst">#{signal}</span>
      after <span class="hljs-subst">#{@process.end-@process.start}</span> ms"</span>
      @code ?= <span class="hljs-number">-1</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> code
      @process.error = <span class="hljs-keyword">new</span> Error <span class="hljs-string">"<span class="hljs-subst">#{@name}</span> exit: code <span class="hljs-subst">#{@result.code}</span>
      after <span class="hljs-subst">#{@process.end-@process.start}</span> ms"</span>
    <span class="hljs-keyword">if</span> @process.error?
      debugCmd @process.error.message
    @emit <span class="hljs-string">'done'</span>, @result.code
    cb <span class="hljs-literal">null</span>, <span class="hljs-keyword">this</span> <span class="hljs-keyword">if</span> cb
  <span class="hljs-keyword">if</span> @setup.timeout
    @timer = setTimeout =&gt;
      debugCmd chalk.grey <span class="hljs-string">"<span class="hljs-subst">#{@name}</span> send KILL because timeout exceeded"</span>
      @proc.kill()
    , @setup.timeout + <span class="hljs-number">1000</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="check-vital-signs">
  <h2>
    <a href="#check-vital-signs" name="check-vital-signs" class="pilcrow"></a>
Check vital signs
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">vital = util.function.onceTime (host, vital, date, cb) -&gt;
  <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">if</span> vital.date <span class="hljs-keyword">is</span> date</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>init startmax</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  conf = config.get <span class="hljs-string">'exec/retry/vital'</span>
  vital.startmax ?= conf.startload * conf.interval / <span class="hljs-number">1000</span> * os.cpus().length</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22"></a>
</div>
<p>calculate cpu usage</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  start = cpuMeasure()
  setTimeout -&gt;
    end = cpuMeasure()
    vital.cpu = <span class="hljs-number">1</span> - (end[<span class="hljs-number">1</span>] - start[<span class="hljs-number">1</span>]) / (end[<span class="hljs-number">0</span>] - start[<span class="hljs-number">0</span>])
    debug chalk.grey <span class="hljs-string">"vital signs: <span class="hljs-subst">#{util.inspect(vital).replace <span class="hljs-regexp">/\s+/g</span>, <span class="hljs-string">' '</span>}</span>"</span>
    cb()
  , MEASURE_TIME</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<p>set the other values</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  vital.date = date
  vital.error = {}
  vital.startload = <span class="hljs-number">0</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24"></a>
</div>
<p>freemem</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  vital.freemem = os.freemem() / os.totalmem()
  vital.load = os.loadavg().map (v) -&gt; v / os.cpus().length</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="measure-cpu-usage">
  <h3>
    <a href="#measure-cpu-usage" name="measure-cpu-usage" class="pilcrow"></a>
Measure CPU usage
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">cpuMeasure</span> = -&gt;</span>
  cpus = os.cpus()
  total = <span class="hljs-number">0</span>
  idle = <span class="hljs-number">0</span>
  <span class="hljs-keyword">for</span> core <span class="hljs-keyword">in</span> cpus
    total += v <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> core.times
    idle += core.times.idle
  [total, idle]</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="export-public-methods">
  <h2>
    <a href="#export-public-methods" name="export-public-methods" class="pilcrow"></a>
Export public methods
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-built_in">module</span>.exports =
  run: run
  vital: vital</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
