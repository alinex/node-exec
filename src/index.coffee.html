<!DOCTYPE html>
<html>
<head>
  <title>index.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = "../", thisFile = "home/alex/a3/node-exec/src/indexcoffee", defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>
  <script src="../fileSearch.js"></script>
  <script src="../goToLine.js"></script>
  <link rel="stylesheet" href="../fileSearch.css" />
  <link rel="stylesheet" href="../goToLine.css" />
</head>
<body>
  <nav>
<div class="logo"><a href="http://alinex.github.io" onmouseover="lllogo.src='https://alinex.github.io/images/Alinex-200.png'" onmouseout="lllogo.src='https://alinex.github.io/images/Alinex-black-200.png'">
  <img name="lllogo" src="https://alinex.github.io/images/Alinex-black-200.png" width="150" title="Alinex Universe Homepage" />
  </a>
  <img src="http://alinex.github.io/images/Alinex-200.png" style="display:none" alt="preloading" />
</div>
<div class="links">
  <a href="http://alinex.github.io/blog" class="btn btn-primary"><span class="glyphicon-cog"></span> Blog</a>
  <a href="http://alinex.github.io/code.html" class="btn btn-warning"><span class="glyphicon-pencil"></span> Code</a>
</div>
</nav><div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
      <div class="heading h1">
        <a href="#execution%20class">Execution class</a>
      </div>
      <div class="heading h2">
        <a href="#node%20modules">Node Modules</a>
      </div>
      <div class="heading h2">
        <a href="#general%20setup">General setup</a>
      </div>
      <div class="heading h2">
        <a href="#class%20definition">Class definition</a>
      </div>
      <div class="heading h3">
        <a href="#vital%20data">Vital Data</a>
      </div>
      <div class="heading h3">
        <a href="#queue">Queue</a>
      </div>
      <div class="heading h3">
        <a href="#initialization">Initialization</a>
      </div>
      <div class="heading h3">
        <a href="#worker">Worker</a>
      </div>
      <div class="heading h3">
        <a href="#start%20execution">Start execution</a>
      </div>
      <div class="heading h3">
        <a href="#result">Result</a>
      </div>
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container" tabindex="0"><a id="fork" href="https://github.com/alinex/node-exec" title="Fork me on GitHub"></a><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
<div class="pilwrap" id="execution%20class">
  <h1>
    <a href="#execution%20class" name="execution%20class" class="pilcrow">&#182;</a>
    Execution class
  </h1>
</div>


<p>This is an object oriented implementation around the core <code>process.spawn</code>
command and alternatively ssh connections.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="node%20modules">
  <h2>
    <a href="#node%20modules" name="node%20modules" class="pilcrow">&#182;</a>
    Node Modules
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3">&#182;</a>
</div>
<p>include base modules</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">debug = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;debug&#39;</span><span class="p">)(</span><span class="s">&#39;exec&#39;</span><span class="p">)</span>
<span class="nv">chalk = </span><span class="nx">require</span> <span class="s">&#39;chalk&#39;</span>
<span class="nv">fspath = </span><span class="nx">require</span> <span class="s">&#39;path&#39;</span>
<span class="nv">os = </span><span class="nx">require</span> <span class="s">&#39;os&#39;</span>
<span class="nv">util = </span><span class="nx">require</span> <span class="s">&#39;util&#39;</span>
<span class="nv">EventEmitter = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;events&#39;</span><span class="p">).</span><span class="nx">EventEmitter</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<p>include alinex modules</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">config = </span><span class="nx">require</span> <span class="s">&#39;alinex-config&#39;</span>
<span class="nv">async = </span><span class="nx">require</span> <span class="s">&#39;alinex-async&#39;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<p>internal helpers</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">schema = </span><span class="nx">require</span> <span class="s">&#39;./configSchema&#39;</span>
<span class="nv">check = </span><span class="nx">require</span> <span class="s">&#39;./check&#39;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="general%20setup">
  <h2>
    <a href="#general%20setup" name="general%20setup" class="pilcrow">&#182;</a>
    General setup
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7">&#182;</a>
</div>
<p>The load should be near the sys and usr time the process needs.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">DEFAULT_LOAD = </span><span class="mf">0.001</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8">&#182;</a>
</div>
<p>counter for unique object IDs</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">objectId = </span><span class="mi">0</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="class%20definition">
  <h2>
    <a href="#class%20definition" name="class%20definition" class="pilcrow">&#182;</a>
    Class definition
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">class</span> <span class="nx">Exec</span> <span class="k">extends</span> <span class="nx">EventEmitter</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="vital%20data">
  <h3>
    <a href="#vital%20data" name="vital%20data" class="pilcrow">&#182;</a>
    Vital Data
  </h3>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11">&#182;</a>
</div>
<p>collection of vital data per host for each interval</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="vi">@vital: </span><span class="p">{}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12">&#182;</a>
</div>
<p>methods for special commands to calculate start load depending on given args
array as a hint you may use the sys and usr time which you get then running
the process but only within a second it may be more than 1.0 if running on
multi core</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="vi">@load:</span>
    <span class="nv">exiftool: </span><span class="nf">-&gt;</span> <span class="mf">0.008</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="queue">
  <h3>
    <a href="#queue" name="queue" class="pilcrow">&#182;</a>
    Queue
  </h3>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14">&#182;</a>
</div>
<p>the queue itself jobs are listed under 'host'->'priority' lists and also
contains the corresponding callbacks</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="vi">@queue: </span><span class="p">{}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15">&#182;</a>
</div>
<p>for statistical information this short summaries will help</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="vi">@queueCounter:</span>
    <span class="nv">total: </span><span class="mi">0</span>
    <span class="nv">host: </span><span class="p">{}</span>
    <span class="nv">priority: </span><span class="p">{}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="initialization">
  <h3>
    <a href="#initialization" name="initialization" class="pilcrow">&#182;</a>
    Initialization
  </h3>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17">&#182;</a>
</div>
<p>set the modules config paths and validation schema</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="vi">@setup: </span><span class="nx">async</span><span class="p">.</span><span class="nx">once</span> <span class="k">this</span><span class="p">,</span> <span class="nf">(cb) -&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18">&#182;</a>
</div>
<p>set module search path</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">config</span><span class="p">.</span><span class="nx">register</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">fspath</span><span class="p">.</span><span class="nx">dirname</span> <span class="nx">__dirname</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19">&#182;</a>
</div>
<p>add schema for module's configuration</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">config</span><span class="p">.</span><span class="nx">setSchema</span> <span class="s">&#39;/exec&#39;</span><span class="p">,</span> <span class="nx">schema</span><span class="p">,</span> <span class="nx">cb</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20">&#182;</a>
</div>
<p>set the modules config paths, validation schema and initialize the configuration</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="vi">@init: </span><span class="nx">async</span><span class="p">.</span><span class="nx">once</span> <span class="k">this</span><span class="p">,</span> <span class="nf">(cb) -&gt;</span>
    <span class="nx">debug</span> <span class="s">&quot;initialize&quot;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21">&#182;</a>
</div>
<p>set module search path</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">@setup</span> <span class="nf">(err) -&gt;</span>
      <span class="k">return</span> <span class="nx">cb</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
      <span class="nx">config</span><span class="p">.</span><span class="nx">init</span> <span class="nx">cb</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="worker">
  <h3>
    <a href="#worker" name="worker" class="pilcrow">&#182;</a>
    Worker
  </h3>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23">&#182;</a>
</div>
<p>The worker is a process which is started if a queue exists and work while the
queue is not done. It will run all the tasks by priority on all hosts.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24">&#182;</a>
</div>
<p>flag if a worker process is already started or running</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="vi">@workerRunning: </span><span class="kc">false</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25">&#182;</a>
</div>
<p>the worker itself</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="vi">@worker: </span><span class="o">=&gt;</span>
    <span class="k">unless</span> <span class="p">(</span><span class="nv">hosts = </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span> <span class="nx">@queue</span><span class="p">).</span><span class="nx">length</span>
      <span class="vi">@workerRunning = </span><span class="kc">false</span>
      <span class="k">return</span>
    <span class="nx">debug</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">grey</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">    worker started: </span><span class="si">#{</span><span class="nx">@queueCounter</span><span class="p">.</span><span class="nx">total</span><span class="si">}</span><span class="s"> total tasks waiting / \</span>
<span class="s">    hosts: </span><span class="si">#{</span><span class="nx">util</span><span class="p">.</span><span class="nx">inspect</span> <span class="nx">@queueCounter</span><span class="p">.</span><span class="nx">host</span><span class="si">}</span><span class="s"> / \</span>
<span class="s">    priority: </span><span class="si">#{</span><span class="nx">util</span><span class="p">.</span><span class="nx">inspect</span> <span class="nx">@queueCounter</span><span class="p">.</span><span class="nx">priority</span><span class="si">}</span><span class="s"></span>
<span class="s">    &quot;&quot;&quot;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26">&#182;</a>
</div>
<p>#####################################################################
   util = require 'util'
   console.log 'WORKER', util.inspect @queue, {depth: null}
   #####################################################################</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">async</span><span class="p">.</span><span class="nx">each</span> <span class="nx">hosts</span><span class="p">,</span> <span class="nf">(host, cb) =&gt;</span>
      <span class="nv">prios = </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span> <span class="nx">@queue</span><span class="p">[</span><span class="nx">host</span><span class="p">]</span>
      <span class="nx">prios</span><span class="p">.</span><span class="nx">reverse</span><span class="p">()</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27">&#182;</a>
</div>

<div class="highlight"><pre><code> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s1">&#39;HOST&#39;</span><span class="p">,</span> <span class="nx">host</span><span class="p">,</span> <span class="nx">prios</span>
</code></pre></div>


        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">async</span><span class="p">.</span><span class="nx">eachSeries</span> <span class="nx">prios</span><span class="p">,</span> <span class="nf">(prio, cb) =&gt;</span>
        <span class="nv">list = </span><span class="nx">@queue</span><span class="p">[</span><span class="nx">host</span><span class="p">][</span><span class="nx">prio</span><span class="p">]</span>
        <span class="k">return</span> <span class="nx">cb</span><span class="p">()</span> <span class="k">unless</span> <span class="nx">list</span><span class="p">.</span><span class="nx">length</span>
        <span class="nx">debug</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">grey</span> <span class="s">&quot;worker running jobs for </span><span class="si">#{</span><span class="nx">host</span><span class="si">}</span><span class="s"> with </span><span class="si">#{</span><span class="nx">prio</span><span class="si">}</span><span class="s"> priority&quot;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28">&#182;</a>
</div>

<div class="highlight"><pre><code>   <span class="nx">async</span><span class="p">.</span><span class="nx">each</span> <span class="nx">list</span><span class="p">,</span> <span class="p">([</span><span class="nx">exec</span><span class="p">,</span> <span class="nx">ocb</span><span class="p">],</span> <span class="nx">cb</span><span class="p">)</span> <span class="o">=&gt;</span>
</code></pre></div>


        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nv">mark = </span><span class="p">[]</span>
        <span class="nx">async</span><span class="p">.</span><span class="nx">forever</span> <span class="nf">(cb) =&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29">&#182;</a>
</div>

<div class="highlight"><pre><code>     <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s1">&#39;?? loop&#39;</span><span class="p">,</span> <span class="nx">list</span><span class="p">.</span><span class="nx">length</span>
</code></pre></div>


        </td>
        <td class="code highlight"><div class="highlight"><pre>
          <span class="k">return</span> <span class="nx">cb</span> <span class="kc">true</span> <span class="k">unless</span> <span class="nx">list</span><span class="p">.</span><span class="nx">length</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30">&#182;</a>
</div>
<p>check if tnext process is already done in this round</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
          <span class="k">return</span> <span class="nx">cb</span> <span class="kc">true</span> <span class="k">if</span> <span class="nx">list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="nx">id</span> <span class="k">in</span> <span class="nx">mark</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31">&#182;</a>
</div>
<p>check</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
          <span class="nx">@vitalCheck</span> <span class="nx">host</span><span class="p">,</span> <span class="nx">prio</span><span class="p">,</span> <span class="nx">DEFAULT_LOAD</span><span class="p">,</span> <span class="nf">(err) =&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32">&#182;</a>
</div>
<p>stop if check failed</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">return</span> <span class="nx">cb</span> <span class="kc">true</span> <span class="k">unless</span> <span class="nx">list</span><span class="p">.</span><span class="nx">length</span>
            <span class="k">return</span> <span class="nx">cb</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33">&#182;</a>
</div>
<p>get first entry</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="p">[</span><span class="nx">exec</span><span class="p">,</span> <span class="nx">ocb</span><span class="p">]</span> <span class="o">=</span> <span class="nx">list</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34">&#182;</a>
</div>

<div class="highlight"><pre><code>       <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s1">&#39;++ loop&#39;</span><span class="p">,</span> <span class="nx">list</span><span class="p">.</span><span class="nx">length</span>
</code></pre></div>



<p>reduce counter</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">@queueCounter</span><span class="p">.</span><span class="nx">total</span><span class="o">--</span>
            <span class="nx">@queueCounter</span><span class="p">.</span><span class="nx">host</span><span class="p">[</span><span class="nx">host</span><span class="p">]</span><span class="o">--</span>
            <span class="nx">@queueCounter</span><span class="p">.</span><span class="nx">priority</span><span class="p">[</span><span class="nx">prio</span><span class="p">]</span><span class="o">--</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35">&#182;</a>
</div>
<p>exec run</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">mark</span><span class="p">.</span><span class="nx">push</span> <span class="nx">exec</span><span class="p">.</span><span class="nx">id</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36">&#182;</a>
</div>

<div class="highlight"><pre><code>       <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s1">&#39;-- exec call&#39;</span><span class="p">,</span> <span class="nx">exec</span><span class="p">.</span><span class="nx">id</span>
</code></pre></div>


        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">exec</span><span class="p">.</span><span class="nx">run</span> <span class="nx">ocb</span>
            <span class="nx">setTimeout</span> <span class="nx">cb</span><span class="p">,</span> <span class="mi">100</span>
        <span class="p">,</span> <span class="nf">(err) =&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37">&#182;</a>
</div>

<div class="highlight"><pre><code>     <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s1">&#39;-- prio done&#39;</span>
</code></pre></div>


        </td>
        <td class="code highlight"><div class="highlight"><pre>
          <span class="nx">debug</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">grey</span> <span class="s">&quot;worker finished round&quot;</span>
          <span class="k">delete</span> <span class="nx">@queue</span><span class="p">[</span><span class="nx">host</span><span class="p">][</span><span class="nx">prio</span><span class="p">]</span> <span class="k">unless</span> <span class="nx">list</span><span class="p">.</span><span class="nx">length</span>
          <span class="nx">cb</span><span class="p">()</span>
      <span class="p">,</span> <span class="nf">(err) =&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38">&#182;</a>
</div>

<div class="highlight"><pre><code>   <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s1">&#39;-- host done&#39;</span>
</code></pre></div>


        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">delete</span> <span class="nx">@queue</span><span class="p">[</span><span class="nx">host</span><span class="p">]</span> <span class="k">unless</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">@queue</span><span class="p">[</span><span class="nx">host</span><span class="p">]).</span><span class="nx">length</span>
        <span class="nx">cb</span><span class="p">()</span>
    <span class="p">,</span> <span class="o">=&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39">&#182;</a>
</div>

<div class="highlight"><pre><code> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s1">&#39;-- all done&#39;</span>
</code></pre></div>



<p>stop worker if completely done</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">unless</span> <span class="nx">Exec</span><span class="p">.</span><span class="nx">queueCounter</span><span class="p">.</span><span class="nx">total</span>
        <span class="vi">@workerRunning = </span><span class="kc">false</span>
        <span class="k">return</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-40" id="section-40">&#182;</a>
</div>
<p>if not rerun it later
     console.log '>>>>>> recall worker'</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">setTimeout</span> <span class="nx">@worker</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;exec/retry/queue/interval&#39;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-41" id="section-41">&#182;</a>
</div>
<p>get and check vital data - this will return an error if anything prevents
from running the process</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="vi">@vitalCheck: </span><span class="nf">(host, priority, load, cb) -&gt;</span>
    <span class="nv">conf = </span><span class="nx">config</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;/exec&#39;</span>
    <span class="nv">vital = </span><span class="nx">@vital</span><span class="p">[</span><span class="nx">host</span><span class="p">]</span> <span class="o">?=</span> <span class="p">{}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-42" id="section-42">&#182;</a>
</div>
<p>get vital data</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nv">date = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">/</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">retry</span><span class="p">.</span><span class="nx">vital</span><span class="p">.</span><span class="nx">interval</span>
    <span class="nv">lib = </span><span class="nx">require</span> <span class="k">if</span> <span class="nx">host</span> <span class="o">is</span> <span class="s">&#39;localhost&#39;</span> <span class="k">then</span> <span class="s">&#39;./spawn&#39;</span> <span class="k">else</span> <span class="s">&#39;./ssh&#39;</span>
    <span class="nx">lib</span><span class="p">.</span><span class="nx">vital</span> <span class="nx">host</span><span class="p">,</span> <span class="nx">vital</span><span class="p">,</span> <span class="nx">date</span><span class="p">,</span> <span class="nf">(err) -&gt;</span>
      <span class="k">return</span> <span class="nx">cb</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-43" id="section-43">&#182;</a>
</div>
<p>check startload</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="nx">vital</span><span class="p">.</span><span class="nx">startload</span> <span class="o">and</span> <span class="nx">vital</span><span class="p">.</span><span class="nx">startload</span> <span class="o">+</span> <span class="nx">load</span> <span class="o">&gt;</span> <span class="nx">vital</span><span class="p">.</span><span class="nx">startmax</span>
        <span class="k">return</span> <span class="nx">cb</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;The maximum load to start per interval would be exceeded</span>
<span class="s">        with this process at </span><span class="si">#{</span><span class="nx">host</span><span class="si">}</span><span class="s">&quot;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-44" id="section-44">&#182;</a>
</div>
<p>error already detected</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">return</span> <span class="nx">cb</span> <span class="nx">vital</span><span class="p">.</span><span class="nx">error</span><span class="p">[</span><span class="nx">priority</span><span class="p">]</span> <span class="k">if</span> <span class="nx">vital</span><span class="p">.</span><span class="nx">error</span><span class="p">[</span><span class="nx">priority</span><span class="p">]</span><span class="o">?</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-45" id="section-45">&#182;</a>
</div>
<p>check for new error</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nv">prio = </span><span class="nx">conf</span><span class="p">.</span><span class="nx">priority</span><span class="p">.</span><span class="nx">level</span><span class="p">[</span><span class="nx">priority</span><span class="p">]</span>
      <span class="nx">vital</span><span class="p">.</span><span class="nx">error</span><span class="p">[</span><span class="nx">priority</span><span class="p">]</span> <span class="o">=</span> <span class="k">if</span> <span class="nx">prio</span><span class="p">.</span><span class="nx">maxCpu</span><span class="o">?</span> <span class="o">and</span> <span class="nx">vital</span><span class="p">.</span><span class="nx">cpu</span> <span class="o">&gt;</span> <span class="nx">prio</span><span class="p">.</span><span class="nx">maxCpu</span>
        <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;The CPU utilization of </span><span class="si">#{</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span> <span class="nx">vital</span><span class="p">.</span><span class="nx">cpu</span> <span class="o">*</span> <span class="mi">100</span><span class="si">}</span><span class="s">% is above</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-46" id="section-46">&#182;</a>
</div>
<p>{Math.round prio.maxCpu * 100}% allowed for #{priority} priority at #{host}"</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="s">      else if prio.minFreemem? and vital.freemem &lt; prio.minFreemem</span>
<span class="s">        new Error &quot;</span><span class="nx">The</span> <span class="nx">free</span> <span class="nx">memory</span> <span class="k">of</span> <span class="c1">#{Math.round vital.freemem * 100}% is below</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-47" id="section-47">&#182;</a>
</div>
<p>{Math.round prio.minFreemem * 100}% allowed for #{priority} priority at #{host}"</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">prio</span><span class="p">.</span><span class="nx">maxLoad</span><span class="o">?</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">?</span> <span class="o">and</span> <span class="nx">vital</span><span class="p">.</span><span class="nx">load</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nx">prio</span><span class="p">.</span><span class="nx">maxLoad</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;The average short load of </span><span class="si">#{</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span> <span class="nx">vital</span><span class="p">.</span><span class="nx">load</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="si">}</span><span class="s"> is above</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-48" id="section-48">&#182;</a>
</div>
<p>{Math.round prio.maxLoad[0] * 100}% allowed for #{priority} priority at #{host}"</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="s">      else if prio.maxLoad?[1]? and vital.load[1] &gt; prio.maxLoad[1]</span>
<span class="s">        new Error &quot;</span><span class="nx">The</span> <span class="nx">average</span> <span class="nx">medium</span> <span class="nx">load</span> <span class="k">of</span> <span class="c1">#{Math.round vital.load[1], 2} is above</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-49" id="section-49">&#182;</a>
</div>
<p>{Math.round prio.maxLoad[1] * 100}% allowed for #{priority} priority at #{host}"</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">prio</span><span class="p">.</span><span class="nx">maxLoad</span><span class="o">?</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">?</span> <span class="o">and</span> <span class="nx">vital</span><span class="p">.</span><span class="nx">load</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nx">prio</span><span class="p">.</span><span class="nx">maxLoad</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;The average long load of </span><span class="si">#{</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span> <span class="nx">vital</span><span class="p">.</span><span class="nx">load</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">2</span><span class="si">}</span><span class="s"> is above</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-50" id="section-50">&#182;</a>
</div>
<p>{Math.round prio.maxLoad[2] * 100}% allowed for #{priority} priority at #{host}"</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="s">      else false</span>
<span class="s">      cb vital.error[priority]</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="start%20execution">
  <h3>
    <a href="#start%20execution" name="start%20execution" class="pilcrow">&#182;</a>
    Start execution
  </h3>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-52" id="section-52">&#182;</a>
</div>
<p>easy call to directly run execution in one statement</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="s">  @run: (setup, cb) -&gt;</span>
<span class="s">    Exec.init (err) -&gt;</span>
<span class="s">      return cb err if err</span>
<span class="s">      proc = new Exec setup</span>
<span class="s">      proc.run cb</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-53" id="section-53">&#182;</a>
</div>
<p>create a new execution object to specify and call later</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="s">  constructor: (@setup) -&gt;</span>
<span class="s">    @id = ++objectId</span>
<span class="s">    host = @setup.remote ? &#39;localhost&#39;</span>
<span class="s">    @name = chalk.grey &quot;</span><span class="c1">#{host}##{@id}:&quot;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-54" id="section-54">&#182;</a>
</div>
<p>set priority</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nv">prio = </span><span class="nx">config</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;exec/priority&#39;</span>
    <span class="nx">@setup</span><span class="p">.</span><span class="nx">priority</span> <span class="o">?=</span> <span class="nx">prio</span><span class="p">.</span><span class="nx">default</span>
    <span class="k">unless</span> <span class="nx">prio</span><span class="p">.</span><span class="nx">level</span><span class="p">[</span><span class="nx">@setup</span><span class="p">.</span><span class="nx">priority</span><span class="p">]</span>
      <span class="nx">debug</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">red</span> <span class="s">&quot;Undefined priority </span><span class="si">#{</span><span class="nx">@setup</span><span class="p">.</span><span class="nx">priority</span><span class="si">}</span><span class="s"> - using default&quot;</span>
      <span class="vi">@setup.priority = </span><span class="nx">prio</span><span class="p">.</span><span class="nx">default</span>
    <span class="nx">debug</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">@name</span><span class="si">}</span><span class="s"> created new instance with </span><span class="si">#{</span><span class="nx">@setup</span><span class="p">.</span><span class="nx">priority</span><span class="si">}</span><span class="s"> priority&quot;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-55" id="section-55">&#182;</a>
</div>
<p>start execution</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">run: </span><span class="nf">(cb) -&gt;</span>
    <span class="k">return</span> <span class="nx">cb</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Already running.&quot;</span> <span class="k">if</span> <span class="nx">@result</span><span class="o">?</span><span class="p">.</span><span class="nx">start</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">@result</span><span class="p">.</span><span class="nx">end</span>
    <span class="nv">host = </span><span class="nx">@setup</span><span class="p">.</span><span class="nx">remote</span> <span class="o">?</span> <span class="s">&#39;localhost&#39;</span>
    <span class="vi">@name = </span><span class="nx">chalk</span><span class="p">.</span><span class="nx">grey</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">host</span><span class="si">}</span><span class="err">#</span><span class="si">#{</span><span class="nx">@id</span><span class="si">}</span><span class="s">:&quot;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-56" id="section-56">&#182;</a>
</div>
<p>optimize cmd - extract arguments</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="o">~</span><span class="nx">@setup</span><span class="p">.</span><span class="nx">cmd</span><span class="p">.</span><span class="nx">indexOf</span> <span class="s">&#39; &#39;</span>
      <span class="nv">parts = </span><span class="nx">@setup</span><span class="p">.</span><span class="nx">cmd</span><span class="p">.</span><span class="nx">match</span> <span class="sr">///</span>
<span class="sr">      (?:         # non-capturing group</span>
<span class="sr">        [^\s&quot;]+   # anything that&#39;s not a space or a double-quote</span>
<span class="sr">        |         # or</span>
<span class="sr">        &quot;[^&quot;]*&quot;   # zero or more characters in double-quotes</span>
<span class="sr">        |         # or</span>
<span class="sr">        &#39;[^&#39;]*&#39;   # zero or more characters in single-quotes</span>
<span class="sr">      )+          # each match is one or more of the things described in the group</span>
<span class="sr">      ///g</span>
      <span class="k">if</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="vi">@setup.cmd = </span><span class="nx">parts</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
        <span class="vi">@setup.args = </span><span class="nx">parts</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">args</span> <span class="o">?</span> <span class="p">[]</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-57" id="section-57">&#182;</a>
</div>
<p># if queue for host exists add this
   return @addQueue null, cb if Exec.queueCounter.host[host]
check existing vital data</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">@conf</span> <span class="o">?=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;/exec&#39;</span>
    <span class="nv">load = </span><span class="nx">Exec</span><span class="p">.</span><span class="nx">load</span><span class="p">[</span><span class="nx">@setup</span><span class="p">.</span><span class="nx">cmd</span><span class="p">]</span><span class="o">?</span><span class="p">(</span><span class="nx">@setup</span><span class="p">.</span><span class="nx">args</span><span class="p">)</span> <span class="o">?</span> <span class="nx">DEFAULT_LOAD</span>
    <span class="nx">Exec</span><span class="p">.</span><span class="nx">vitalCheck</span> <span class="nx">host</span><span class="p">,</span> <span class="nx">@setup</span><span class="p">.</span><span class="nx">priority</span><span class="p">,</span> <span class="nx">load</span><span class="p">,</span> <span class="nf">(err) =&gt;</span>
      <span class="k">return</span> <span class="nx">@addQueue</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">cb</span> <span class="k">if</span> <span class="nx">err</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-58" id="section-58">&#182;</a>
</div>
<p>add load to calculate startlimit</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">Exec</span><span class="p">.</span><span class="nx">vital</span><span class="p">[</span><span class="nx">host</span><span class="p">].</span><span class="nx">startload</span> <span class="o">+=</span> <span class="nx">load</span>
      <span class="nx">debug</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">@name</span><span class="si">}</span><span class="s"> with </span><span class="si">#{</span><span class="nx">@setup</span><span class="p">.</span><span class="nx">priority</span><span class="si">}</span><span class="s"> priority at </span><span class="si">#{</span><span class="nx">host</span><span class="si">}</span><span class="s">&quot;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-59" id="section-59">&#182;</a>
</div>
<p>run locally or remote</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nv">lib = </span><span class="nx">require</span> <span class="k">if</span> <span class="nx">host</span> <span class="o">is</span> <span class="s">&#39;localhost&#39;</span> <span class="k">then</span> <span class="s">&#39;./spawn&#39;</span> <span class="k">else</span> <span class="s">&#39;./ssh&#39;</span>
      <span class="nx">lib</span><span class="p">.</span><span class="nx">run</span><span class="p">.</span><span class="nx">call</span> <span class="k">this</span><span class="p">,</span> <span class="nf">(err) =&gt;</span>
        <span class="k">if</span> <span class="nx">err</span>
          <span class="nx">debug</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">@name</span><span class="si">}</span><span class="s"> failed with </span><span class="si">#{</span><span class="nx">err</span><span class="si">}</span><span class="s">&quot;</span>
          <span class="k">return</span> <span class="nx">cb</span> <span class="nx">err</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-60" id="section-60">&#182;</a>
</div>
<p>success</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">@checkResult</span> <span class="nx">cb</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-61" id="section-61">&#182;</a>
</div>
<p>if direct execution is not possible add this task to the queue</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">addQueue: </span><span class="nf">(err, cb) -&gt;</span>
    <span class="nv">host = </span><span class="nx">@setup</span><span class="p">.</span><span class="nx">remote</span> <span class="o">?</span> <span class="s">&#39;localhost&#39;</span>
    <span class="k">if</span> <span class="nx">err</span>
      <span class="nx">debug</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">grey</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">@name</span><span class="si">}</span><span class="s"> add to queue because: </span><span class="si">#{</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="k">else</span>
      <span class="nx">debug</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">grey</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">@name</span><span class="si">}</span><span class="s"> add to queue because other processes are waiting&quot;</span>
    <span class="k">unless</span> <span class="nx">Exec</span><span class="p">.</span><span class="nx">workerRunning</span>
      <span class="nv">Exec.workerRunning = </span><span class="kc">true</span>
      <span class="nx">setTimeout</span> <span class="nx">Exec</span><span class="p">.</span><span class="nx">worker</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;exec/retry/queue/interval&#39;</span>
    <span class="nx">Exec</span><span class="p">.</span><span class="nx">queue</span><span class="p">[</span><span class="nx">host</span><span class="p">]</span> <span class="o">?=</span> <span class="p">{}</span>
    <span class="nx">Exec</span><span class="p">.</span><span class="nx">queue</span><span class="p">[</span><span class="nx">host</span><span class="p">][</span><span class="nx">@setup</span><span class="p">.</span><span class="nx">priority</span><span class="p">]</span> <span class="o">?=</span> <span class="p">[]</span>
    <span class="nx">Exec</span><span class="p">.</span><span class="nx">queue</span><span class="p">[</span><span class="nx">host</span><span class="p">][</span><span class="nx">@setup</span><span class="p">.</span><span class="nx">priority</span><span class="p">].</span><span class="nx">push</span> <span class="p">[</span><span class="k">this</span><span class="p">,</span> <span class="nx">cb</span><span class="p">]</span>
    <span class="nx">Exec</span><span class="p">.</span><span class="nx">queueCounter</span><span class="p">.</span><span class="nx">total</span><span class="o">++</span>
    <span class="nx">Exec</span><span class="p">.</span><span class="nx">queueCounter</span><span class="p">.</span><span class="nx">host</span><span class="p">[</span><span class="nx">host</span><span class="p">]</span> <span class="o">?=</span> <span class="mi">0</span>
    <span class="nx">Exec</span><span class="p">.</span><span class="nx">queueCounter</span><span class="p">.</span><span class="nx">host</span><span class="p">[</span><span class="nx">host</span><span class="p">]</span><span class="o">++</span>
    <span class="nx">Exec</span><span class="p">.</span><span class="nx">queueCounter</span><span class="p">.</span><span class="nx">priority</span><span class="p">[</span><span class="nx">@setup</span><span class="p">.</span><span class="nx">priority</span><span class="p">]</span> <span class="o">?=</span> <span class="mi">0</span>
    <span class="nx">Exec</span><span class="p">.</span><span class="nx">queueCounter</span><span class="p">.</span><span class="nx">priority</span><span class="p">[</span><span class="nx">@setup</span><span class="p">.</span><span class="nx">priority</span><span class="p">]</span><span class="o">++</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="result">
  <h3>
    <a href="#result" name="result" class="pilcrow">&#182;</a>
    Result
  </h3>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-63" id="section-63">&#182;</a>
</div>
<p>run defined checks on result</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">checkResult: </span><span class="nf">(cb) -&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-64" id="section-64">&#182;</a>
</div>
<p>find check to use</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nv">list = </span><span class="nx">@setup</span><span class="p">.</span><span class="nx">check</span> <span class="o">?</span> <span class="p">{</span>
      <span class="nv">noExitCode:</span>
        <span class="nv">retry: </span><span class="nx">@setup</span><span class="p">.</span><span class="nx">retry</span><span class="o">?</span><span class="p">.</span><span class="nx">times</span>
    <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-65" id="section-65">&#182;</a>
</div>
<p>run checks</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">for</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">list</span>
      <span class="k">return</span> <span class="nx">cb</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Unknown check function </span><span class="si">#{</span><span class="nx">n</span><span class="si">}</span><span class="s"> in Exec&quot;</span> <span class="k">unless</span> <span class="nx">check</span><span class="p">[</span><span class="nx">n</span><span class="p">]</span><span class="o">?</span>
      <span class="nv">err = </span><span class="nx">check</span><span class="p">[</span><span class="nx">n</span><span class="p">].</span><span class="nx">apply</span> <span class="k">this</span><span class="p">,</span> <span class="nx">v</span><span class="p">.</span><span class="nx">args</span> <span class="o">?</span> <span class="kc">null</span>
      <span class="k">continue</span> <span class="k">unless</span> <span class="nx">err</span>
      <span class="nx">debug</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">magenta</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">@name</span><span class="si">}</span><span class="s"> </span><span class="si">#{</span><span class="nx">n</span><span class="si">}</span><span class="s">: </span><span class="si">#{</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="s">&quot;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-66" id="section-66">&#182;</a>
</div>
<p>got an error</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="vi">@result.error = </span><span class="nx">err</span>
      <span class="k">if</span> <span class="nx">v</span><span class="p">.</span><span class="nx">retry</span>
        <span class="nv">times = </span><span class="nx">@setup</span><span class="p">.</span><span class="nx">retry</span><span class="p">.</span><span class="nx">times</span> <span class="o">?</span> <span class="nx">@conf</span><span class="p">.</span><span class="nx">retry</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">times</span>
        <span class="k">if</span> <span class="nx">@tries</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="nx">times</span>
          <span class="nx">debug</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">red</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">@name</span><span class="si">}</span><span class="s"> reached </span><span class="si">#{</span><span class="nx">times</span><span class="si">}</span><span class="s"> retries - giving up&quot;</span>
          <span class="k">return</span> <span class="nx">cb</span> <span class="nx">err</span><span class="p">,</span> <span class="k">this</span>
        <span class="k">return</span> <span class="nx">setTimeout</span> <span class="o">=&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-67" id="section-67">&#182;</a>
</div>
<p>store last try</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
          <span class="nx">@tries</span> <span class="o">?=</span> <span class="p">[]</span>
          <span class="nx">@tries</span><span class="p">.</span><span class="nx">push</span>
            <span class="nv">process: </span><span class="nx">@process</span>
            <span class="nv">result: </span><span class="nx">@result</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-68" id="section-68">&#182;</a>
</div>
<p>run again</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
          <span class="k">this</span><span class="p">.</span><span class="nx">run</span> <span class="nx">cb</span>
        <span class="p">,</span> <span class="nx">@setup</span><span class="p">.</span><span class="nx">retry</span><span class="p">.</span><span class="nx">interval</span> <span class="o">?</span> <span class="nx">@conf</span><span class="p">.</span><span class="nx">retry</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">interval</span>
      <span class="k">return</span> <span class="nx">cb</span> <span class="nx">err</span><span class="p">,</span> <span class="k">this</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-69" id="section-69">&#182;</a>
</div>
<p>everything ok, go on</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">debug</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">@name</span><span class="si">}</span><span class="s"> succeeded&quot;</span>
    <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="k">this</span>

  <span class="nv">stdout: </span><span class="nf">(data) -&gt;</span>
    <span class="nx">data</span> <span class="o">?=</span> <span class="nx">@result</span>
    <span class="k">return</span> <span class="nx">data</span><span class="p">.</span><span class="nx">stdout</span> <span class="k">if</span> <span class="nx">data</span><span class="p">.</span><span class="nx">stdout</span>
    <span class="nv">stdout = </span><span class="nx">data</span><span class="p">.</span><span class="nx">lines</span>
    <span class="p">.</span><span class="nx">filter</span> <span class="nf">(e) -&gt;</span> <span class="nx">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">is</span> <span class="mi">1</span>
    <span class="p">.</span><span class="nx">map</span> <span class="nf">(e) -&gt;</span> <span class="nx">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">.</span><span class="nx">join</span> <span class="s">&#39;\n&#39;</span>
    <span class="nv">data.stdout = </span><span class="nx">stdout</span> <span class="k">if</span> <span class="nx">data</span><span class="p">.</span><span class="nx">code</span><span class="o">?</span>
    <span class="nx">stdout</span>

  <span class="nv">stderr: </span><span class="nf">(data) -&gt;</span>
    <span class="nx">data</span> <span class="o">?=</span> <span class="nx">@result</span>
    <span class="k">return</span> <span class="nx">data</span><span class="p">.</span><span class="nx">stderr</span> <span class="k">if</span> <span class="nx">data</span><span class="p">.</span><span class="nx">stderr</span>
    <span class="nv">stderr = </span><span class="nx">data</span><span class="p">.</span><span class="nx">lines</span>
    <span class="p">.</span><span class="nx">filter</span> <span class="nf">(e) -&gt;</span> <span class="nx">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">is</span> <span class="mi">2</span>
    <span class="p">.</span><span class="nx">map</span> <span class="nf">(e) -&gt;</span> <span class="nx">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">.</span><span class="nx">join</span> <span class="s">&#39;\n&#39;</span>
    <span class="nv">data.stderr = </span><span class="nx">stderr</span> <span class="k">if</span> <span class="nx">data</span><span class="p">.</span><span class="nx">code</span><span class="o">?</span>
    <span class="nx">stderr</span>

<span class="nv">module.exports = </span><span class="nx">Exec</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
