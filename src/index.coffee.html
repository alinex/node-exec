<!DOCTYPE html>
<html>
<head>
  <title>index.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = "../";
    var thisFile = "home/alex/github/node-exec/src/index.coffee";
    var defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>

<meta name="viewport" content="width=device-width, initial-scale=1.0" /></head
<body>
  <nav>
<div class="logo"><a href="http://alinex.github.io"
  onmouseover="logo.src='https://alinex.github.io/images/Alinex-200.png'"
  onmouseout="logo.src='https://alinex.github.io/images/Alinex-black-200.png'">
  <img name="logo" src="https://alinex.github.io/images/Alinex-black-200.png"
    width="150" title="Alinex Universe Homepage" />
  </a>
  <img src="http://alinex.github.io/images/Alinex-200.png"
    style="display:none" alt="preloading" />
</div>
<div class="links">
  <a href="http://alinex.github.io/blog"
    class="btn btn-primary"><span class="glyphicon-pencil"></span> Blog</a>
  <a href="http://alinex.github.io/develop"
    class="btn btn-primary"><span class="glyphicon-book"></span> Develop</a>
  <a href="http://alinex.github.io/code.html"
    class="btn btn-warning"><span class="glyphicon-cog"></span> Code</a>
</div>
</nav><div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

      <div class="heading h1">
        <a href="#execution-class">Execution class</a>
      </div>

      <div class="heading h2">
        <a href="#node-modules">Node Modules</a>
      </div>

      <div class="heading h2">
        <a href="#general-setup">General setup</a>
      </div>

      <div class="heading h2">
        <a href="#class-definition">Class definition</a>
      </div>

      <div class="heading h3">
        <a href="#vital-data">Vital Data</a>
      </div>

      <div class="heading h3">
        <a href="#queue">Queue</a>
      </div>

      <div class="heading h3">
        <a href="#initialization">Initialization</a>
      </div>

      <div class="heading h3">
        <a href="#worker">Worker</a>
      </div>

      <div class="heading h3">
        <a href="#start-execution">Start execution</a>
      </div>

      <div class="heading h3">
        <a href="#close-remote-connections">Close remote connections</a>
      </div>

      <div class="heading h1">
        <a href="#if-queue-for-host-exists-add-this">if queue for host exists add this</a>
      </div>

      <div class="heading h3">
        <a href="#result">Result</a>
      </div>

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container" tabindex="0"><a id="fork" href="https://github.com/alinex/node-exec" title="Fork me on GitHub"></a>
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="execution-class">
  <h1>
    <a href="#execution-class" name="execution-class" class="pilcrow"></a>
Execution class
  </h1>
</div>
<p>This is an object oriented implementation around the core <code>process.spawn</code>
command and alternatively ssh connections.</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="node-modules">
  <h2>
    <a href="#node-modules" name="node-modules" class="pilcrow"></a>
Node Modules
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>include base modules</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">debug = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'exec'</span>)
chalk = <span class="hljs-built_in">require</span> <span class="hljs-string">'chalk'</span>
fspath = <span class="hljs-built_in">require</span> <span class="hljs-string">'path'</span>
util = <span class="hljs-built_in">require</span> <span class="hljs-string">'util'</span>
EventEmitter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'events'</span>).EventEmitter
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>include alinex modules</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">config = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-config'</span>
async = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-async'</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>internal helpers</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">schema = <span class="hljs-built_in">require</span> <span class="hljs-string">'./configSchema'</span>
check = <span class="hljs-built_in">require</span> <span class="hljs-string">'./check'</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="general-setup">
  <h2>
    <a href="#general-setup" name="general-setup" class="pilcrow"></a>
General setup
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>The load should be near the sys and usr time the process needs.</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">DEFAULT_LOAD = <span class="hljs-number">0.001</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>counter for unique object IDs</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">objectId = <span class="hljs-number">0</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="class-definition">
  <h2>
    <a href="#class-definition" name="class-definition" class="pilcrow"></a>
Class definition
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Exec</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">EventEmitter</span></span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="vital-data">
  <h3>
    <a href="#vital-data" name="vital-data" class="pilcrow"></a>
Vital Data
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>collection of vital data per host for each interval</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-property">@vital</span>: {}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>methods for special commands to calculate start load depending on given args
array as a hint you may use the sys and usr time which you get then running
the process but only within a second it may be more than 1.0 if running on
multi core</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-property">@load</span>:
    <span class="hljs-attribute">exiftool</span>: <span class="hljs-function">-&gt;</span> <span class="hljs-number">0.008</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="queue">
  <h3>
    <a href="#queue" name="queue" class="pilcrow"></a>
Queue
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>the queue itself jobs are listed under 'host'-&gt;'priority' lists and also
contains the corresponding callbacks</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-property">@queue</span>: {}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>for statistical information this short summaries will help</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-property">@queueCounter</span>:
    <span class="hljs-attribute">total</span>: <span class="hljs-number">0</span>
    <span class="hljs-attribute">host</span>: {}
    <span class="hljs-attribute">priority</span>: {}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="initialization">
  <h3>
    <a href="#initialization" name="initialization" class="pilcrow"></a>
Initialization
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>set the modules config paths and validation schema</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-property">@setup</span>: async.once <span class="hljs-keyword">this</span>, <span class="hljs-function"><span class="hljs-params">(cb)</span> -&gt;</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>set module search path</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    config.register <span class="hljs-literal">false</span>, fspath.dirname __dirname
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>add schema for module's configuration</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    config.setSchema <span class="hljs-string">'/exec'</span>, schema, cb

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>set the modules config paths, validation schema and initialize the configuration</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-property">@init</span>: async.once <span class="hljs-keyword">this</span>, <span class="hljs-function"><span class="hljs-params">(cb)</span> -&gt;</span>
    debug <span class="hljs-string">"initialize"</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>set module search path</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-property">@setup</span> (err) -&gt;
      <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
      config.init cb

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="worker">
  <h3>
    <a href="#worker" name="worker" class="pilcrow"></a>
Worker
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<p>The worker is a process which is started if a queue exists and work while the
queue is not done. It will run all the tasks by priority on all hosts.</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24"></a>
</div>
<p>flag if a worker process is already started or running</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-property">@workerRunning</span>: <span class="hljs-literal">false</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25"></a>
</div>
<p>the worker itself</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-property">@worker</span>: <span class="hljs-function">=&gt;</span>
    <span class="hljs-keyword">unless</span> (hosts = Object.keys <span class="hljs-property">@queue</span>).length
      <span class="hljs-property">@workerRunning</span> = <span class="hljs-literal">false</span>
      <span class="hljs-keyword">return</span>
    debug chalk.grey <span class="hljs-string">"""
    worker started: <span class="hljs-subst">#{<span class="hljs-property">@queueCounter</span>.total}</span> total tasks waiting / \
    hosts: <span class="hljs-subst">#{util.inspect <span class="hljs-property">@queueCounter</span>.host}</span> / \
    priority: <span class="hljs-subst">#{util.inspect <span class="hljs-property">@queueCounter</span>.priority}</span>
    """</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26"></a>
</div>
<p>#####################################################################
util = require 'util'
console.log 'WORKER', util.inspect @queue, {depth: null}
#####################################################################</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    async.each hosts, <span class="hljs-function"><span class="hljs-params">(host, cb)</span> =&gt;</span>
      prios = Object.keys <span class="hljs-property">@queue</span>[host]
      prios.reverse()
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27"></a>
</div>
<pre><code> console.log 'HOST', host, prios
</code></pre>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      async.eachSeries prios, <span class="hljs-function"><span class="hljs-params">(prio, cb)</span> =&gt;</span>
        list = <span class="hljs-property">@queue</span>[host][prio]
        <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">unless</span> list.length
        debug chalk.grey <span class="hljs-string">"worker running jobs for <span class="hljs-subst">#{host}</span> with <span class="hljs-subst">#{prio}</span> priority"</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28"></a>
</div>
<pre><code>   async.each list, ([exec, ocb], cb) =&gt;
</code></pre>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">        mark = []
        async.forever (cb) =&gt;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29"></a>
</div>
<pre><code>     console.log '?? loop', list.length
</code></pre>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">          <span class="hljs-keyword">return</span> cb <span class="hljs-literal">true</span> <span class="hljs-keyword">unless</span> list.length
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30"></a>
</div>
<p>check if next process is already done in this round</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">          <span class="hljs-keyword">return</span> cb <span class="hljs-literal">true</span> <span class="hljs-keyword">if</span> list[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>].id <span class="hljs-keyword">in</span> mark
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31"></a>
</div>
<p>check</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">          <span class="hljs-property">@vitalCheck</span> host, prio, DEFAULT_LOAD, <span class="hljs-function"><span class="hljs-params">(err)</span> =&gt;</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32"></a>
</div>
<p>stop if check failed</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">            <span class="hljs-keyword">return</span> cb <span class="hljs-literal">true</span> <span class="hljs-keyword">unless</span> list.length
            <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33"></a>
</div>
<p>get first entry</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">            [exec, ocb] = list.shift()
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34"></a>
</div>
<pre><code>       console.log '++ loop', list.length
</code></pre>
<p>reduce counter</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">            <span class="hljs-property">@queueCounter</span>.total--
            <span class="hljs-property">@queueCounter</span>.host[host]--
            <span class="hljs-property">@queueCounter</span>.priority[prio]--
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35"></a>
</div>
<p>exec run</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">            mark.push exec.id
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36"></a>
</div>
<pre><code>       console.log '-- exec call', exec.id
</code></pre>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">            exec.run ocb
            setTimeout cb, <span class="hljs-number">100</span>
        , <span class="hljs-function"><span class="hljs-params">(err)</span> =&gt;</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37"></a>
</div>
<pre><code>     console.log '-- prio done'
</code></pre>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">          debug chalk.grey <span class="hljs-string">"worker finished round"</span>
          <span class="hljs-keyword">delete</span> <span class="hljs-property">@queue</span>[host][prio] <span class="hljs-keyword">unless</span> list.length
          cb err
      , <span class="hljs-function"><span class="hljs-params">(err)</span> =&gt;</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38"></a>
</div>
<pre><code>   console.log '-- host done'
</code></pre>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">        <span class="hljs-keyword">delete</span> <span class="hljs-property">@queue</span>[host] <span class="hljs-keyword">unless</span> Object.keys(<span class="hljs-property">@queue</span>[host]).length
        cb err
    , <span class="hljs-function">=&gt;</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39"></a>
</div>
<pre><code> console.log '-- all done'
</code></pre>
<p>stop worker if completely done</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      <span class="hljs-keyword">unless</span> Exec.queueCounter.total
        <span class="hljs-property">@workerRunning</span> = <span class="hljs-literal">false</span>
        <span class="hljs-keyword">return</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-40" id="section-40"></a>
</div>
<p>if not rerun it later
console.log '&gt;&gt;&gt;&gt;&gt;&gt; recall worker'</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      setTimeout <span class="hljs-property">@worker</span>, config.get <span class="hljs-string">'exec/retry/queue/interval'</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-41" id="section-41"></a>
</div>
<p>get and check vital data - this will return an error if anything prevents
from running the process</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-property">@vitalCheck</span>: <span class="hljs-function"><span class="hljs-params">(host, priority, load, cb)</span> -&gt;</span>
    conf = config.get <span class="hljs-string">'/exec'</span>
    prio = conf.priority.level[priority]
    vital = <span class="hljs-property">@vital</span>[host] ?= {}
    <span class="hljs-keyword">return</span> cb <span class="hljs-literal">null</span>, <span class="hljs-literal">false</span> <span class="hljs-keyword">unless</span> prio.maxCpu? <span class="hljs-keyword">or</span> prio.minFreemem? <span class="hljs-keyword">or</span> prio.maxLoad?
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-42" id="section-42"></a>
</div>
<p>prevent vital check if no restrictions</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-keyword">return</span> cb <span class="hljs-literal">null</span>, <span class="hljs-literal">false</span> <span class="hljs-keyword">unless</span> prio.minFreemem? <span class="hljs-keyword">or</span> prio.maxCpu? <span class="hljs-keyword">or</span> prio.maxLoad?
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-43" id="section-43"></a>
</div>
<p>get vital data</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    date = Math.floor <span class="hljs-keyword">new</span> Date().getTime() / conf.retry.vital.interval
    lib = <span class="hljs-built_in">require</span> <span class="hljs-keyword">if</span> host <span class="hljs-keyword">is</span> <span class="hljs-string">'localhost'</span> <span class="hljs-keyword">then</span> <span class="hljs-string">'./spawn'</span> <span class="hljs-keyword">else</span> <span class="hljs-string">'./ssh'</span>
    lib.vital host, vital, date, <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span>
      <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-44" id="section-44"></a>
</div>
<p>check startload</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      <span class="hljs-keyword">if</span> vital.startload <span class="hljs-keyword">and</span> vital.startload + load &gt; vital.startmax
        <span class="hljs-keyword">return</span> cb <span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> Error <span class="hljs-string">"The maximum load to start per interval would be exceeded
        with this process at <span class="hljs-subst">#{host}</span>"</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-45" id="section-45"></a>
</div>
<p>error already detected</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      <span class="hljs-keyword">return</span> cb <span class="hljs-literal">null</span>, vital.error[priority] <span class="hljs-keyword">if</span> vital.error[priority]?
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-46" id="section-46"></a>
</div>
<p>check for new error</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      vital.error[priority] = <span class="hljs-keyword">if</span> prio.maxCpu? <span class="hljs-keyword">and</span> vital.cpu &gt; prio.maxCpu
        <span class="hljs-keyword">new</span> Error <span class="hljs-string">"The CPU utilization of <span class="hljs-subst">#{Math.round vital.cpu * <span class="hljs-number">100</span>}</span>% is above
</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-47" id="section-47"></a>
</div>
<p>{Math.round prio.maxCpu * 100}% allowed for #{priority} priority at #{host}&quot;</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> prio.minFreemem? <span class="hljs-keyword">and</span> vital.freemem &lt; prio.minFreemem
        <span class="hljs-keyword">new</span> Error <span class="hljs-string">"The free memory of <span class="hljs-subst">#{Math.round vital.freemem * <span class="hljs-number">100</span>}</span>% is below
</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-48" id="section-48"></a>
</div>
<p>{Math.round prio.minFreemem * 100}% allowed for #{priority} priority at #{host}&quot;</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> prio.maxLoad?[<span class="hljs-number">0</span>]? <span class="hljs-keyword">and</span> vital.load[<span class="hljs-number">0</span>] &gt; prio.maxLoad[<span class="hljs-number">0</span>]
        <span class="hljs-keyword">new</span> Error <span class="hljs-string">"The average short load of <span class="hljs-subst">#{Math.round vital.load[<span class="hljs-number">0</span>], <span class="hljs-number">2</span>}</span> is above
</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-49" id="section-49"></a>
</div>
<p>{Math.round prio.maxLoad[0] * 100}% allowed for #{priority} priority at #{host}&quot;</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> prio.maxLoad?[<span class="hljs-number">1</span>]? <span class="hljs-keyword">and</span> vital.load[<span class="hljs-number">1</span>] &gt; prio.maxLoad[<span class="hljs-number">1</span>]
        <span class="hljs-keyword">new</span> Error <span class="hljs-string">"The average medium load of <span class="hljs-subst">#{Math.round vital.load[<span class="hljs-number">1</span>], <span class="hljs-number">2</span>}</span> is above
</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-50" id="section-50"></a>
</div>
<p>{Math.round prio.maxLoad[1] * 100}% allowed for #{priority} priority at #{host}&quot;</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> prio.maxLoad?[<span class="hljs-number">2</span>]? <span class="hljs-keyword">and</span> vital.load[<span class="hljs-number">2</span>] &gt; prio.maxLoad[<span class="hljs-number">2</span>]
        <span class="hljs-keyword">new</span> Error <span class="hljs-string">"The average long load of <span class="hljs-subst">#{Math.round vital.load[<span class="hljs-number">2</span>], <span class="hljs-number">2</span>}</span> is above
</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-51" id="section-51"></a>
</div>
<p>{Math.round prio.maxLoad[2] * 100}% allowed for #{priority} priority at #{host}&quot;</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      <span class="hljs-keyword">else</span> <span class="hljs-literal">false</span>
      cb <span class="hljs-literal">null</span>, vital.error[priority]

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="start-execution">
  <h3>
    <a href="#start-execution" name="start-execution" class="pilcrow"></a>
Start execution
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-53" id="section-53"></a>
</div>
<p>easy call to directly run execution in one statement</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-property">@run</span>: <span class="hljs-function"><span class="hljs-params">(setup, cb)</span> -&gt;</span>
    Exec.init (err) -&gt;
      <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
      proc = <span class="hljs-keyword">new</span> Exec setup
      proc.run cb

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="close-remote-connections">
  <h3>
    <a href="#close-remote-connections" name="close-remote-connections" class="pilcrow"></a>
Close remote connections
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-property">@close</span>: <span class="hljs-function">-&gt;</span>
    lib = <span class="hljs-built_in">require</span> <span class="hljs-string">'./ssh'</span>
    lib.closeAll()

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-55" id="section-55"></a>
</div>
<p>create a new execution object to specify and call later</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@setup</span>)</span> -&gt;</span>
    <span class="hljs-property">@id</span> = ++objectId
    host = <span class="hljs-property">@setup</span>.remote ? <span class="hljs-string">'localhost'</span>
    <span class="hljs-property">@name</span> = chalk.grey <span class="hljs-string">"<span class="hljs-subst">#{host}</span>#<span class="hljs-subst">#{<span class="hljs-property">@id</span>}</span>:"</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-56" id="section-56"></a>
</div>
<p>set priority</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    prio = config.get <span class="hljs-string">'exec/priority'</span>
    <span class="hljs-property">@setup</span>.priority ?= prio.default
    <span class="hljs-keyword">unless</span> prio.level[<span class="hljs-property">@setup</span>.priority]
      debug chalk.red <span class="hljs-string">"Undefined priority <span class="hljs-subst">#{<span class="hljs-property">@setup</span>.priority}</span> - using default"</span>
      <span class="hljs-property">@setup</span>.priority = prio.default
    debug <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@name</span>}</span> created new instance with <span class="hljs-subst">#{<span class="hljs-property">@setup</span>.priority}</span> priority"</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-57" id="section-57"></a>
</div>
<p>start execution</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-attribute">run</span>: <span class="hljs-function"><span class="hljs-params">(cb)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> cb <span class="hljs-keyword">new</span> Error <span class="hljs-string">"Already running."</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@result</span>?.start <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@result</span>.end
    host = <span class="hljs-property">@setup</span>.remote ? <span class="hljs-string">'localhost'</span>
    <span class="hljs-property">@name</span> = chalk.grey <span class="hljs-string">"<span class="hljs-subst">#{host}</span>#<span class="hljs-subst">#{<span class="hljs-property">@id</span>}</span>:"</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-58" id="section-58"></a>
</div>
<p>optimize cmd - extract arguments</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-keyword">if</span> ~<span class="hljs-property">@setup</span>.cmd.indexOf <span class="hljs-string">' '</span>
      parts = <span class="hljs-property">@setup</span>.cmd.match <span class="hljs-regexp">///
      (?:         <span class="hljs-comment"># non-capturing group</span>
        [^\s"]+   <span class="hljs-comment"># anything that's not a space or a double-quote</span>
        |         <span class="hljs-comment"># or</span>
        "[^"]*"   <span class="hljs-comment"># zero or more characters in double-quotes</span>
        |         <span class="hljs-comment"># or</span>
        '[^']*'   <span class="hljs-comment"># zero or more characters in single-quotes</span>
      )+          <span class="hljs-comment"># each match is one or more of the things described in the group</span>
      ///</span>g
      <span class="hljs-keyword">if</span> parts.length &gt; <span class="hljs-number">1</span>
        <span class="hljs-property">@setup</span>.cmd = parts.shift()
        <span class="hljs-property">@setup</span>.args = parts.concat <span class="hljs-property">@setup</span>.args ? []
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="if-queue-for-host-exists-add-this">
  <h1>
    <a href="#if-queue-for-host-exists-add-this" name="if-queue-for-host-exists-add-this" class="pilcrow"></a>
if queue for host exists add this
  </h1>
</div>
<p>return @addQueue null, cb if Exec.queueCounter.host[host]
check existing vital data</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-property">@conf</span> ?= config.get <span class="hljs-string">'/exec'</span>
    load = Exec.load[<span class="hljs-property">@setup</span>.cmd]?(<span class="hljs-property">@setup</span>.args) ? DEFAULT_LOAD
    Exec.vitalCheck host, <span class="hljs-property">@setup</span>.priority, load, <span class="hljs-function"><span class="hljs-params">(err, res)</span> =&gt;</span>
      <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
      <span class="hljs-keyword">return</span> <span class="hljs-property">@addQueue</span> res, cb <span class="hljs-keyword">if</span> res
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-60" id="section-60"></a>
</div>
<p>add load to calculate startlimit</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      Exec.vital[host].startload += load
      debug <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@name</span>}</span> with <span class="hljs-subst">#{<span class="hljs-property">@setup</span>.priority}</span> priority at <span class="hljs-subst">#{host}</span>"</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-61" id="section-61"></a>
</div>
<p>run locally or remote</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      lib = <span class="hljs-built_in">require</span> <span class="hljs-keyword">if</span> host <span class="hljs-keyword">is</span> <span class="hljs-string">'localhost'</span> <span class="hljs-keyword">then</span> <span class="hljs-string">'./spawn'</span> <span class="hljs-keyword">else</span> <span class="hljs-string">'./ssh'</span>
      lib.run.call <span class="hljs-keyword">this</span>, <span class="hljs-function"><span class="hljs-params">(err)</span> =&gt;</span>
        <span class="hljs-keyword">if</span> err
          debug <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@name</span>}</span> failed with <span class="hljs-subst">#{err}</span>"</span>
          <span class="hljs-keyword">return</span> cb err
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-62" id="section-62"></a>
</div>
<p>success</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">        <span class="hljs-property">@checkResult</span> cb

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-63" id="section-63"></a>
</div>
<p>if direct execution is not possible add this task to the queue</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-attribute">addQueue</span>: <span class="hljs-function"><span class="hljs-params">(err, cb)</span> -&gt;</span>
    host = <span class="hljs-property">@setup</span>.remote ? <span class="hljs-string">'localhost'</span>
    <span class="hljs-keyword">if</span> err
      debug chalk.grey <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@name</span>}</span> add to queue because: <span class="hljs-subst">#{err.message}</span>"</span>
    <span class="hljs-keyword">else</span>
      debug chalk.grey <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@name</span>}</span> add to queue because other processes are waiting"</span>
    <span class="hljs-keyword">unless</span> Exec.workerRunning
      Exec.workerRunning = <span class="hljs-literal">true</span>
      setTimeout Exec.worker, config.get <span class="hljs-string">'exec/retry/queue/interval'</span>
    Exec.queue[host] ?= {}
    Exec.queue[host][<span class="hljs-property">@setup</span>.priority] ?= []
    Exec.queue[host][<span class="hljs-property">@setup</span>.priority].push [<span class="hljs-keyword">this</span>, cb]
    Exec.queueCounter.total++
    Exec.queueCounter.host[host] ?= <span class="hljs-number">0</span>
    Exec.queueCounter.host[host]++
    Exec.queueCounter.priority[<span class="hljs-property">@setup</span>.priority] ?= <span class="hljs-number">0</span>
    Exec.queueCounter.priority[<span class="hljs-property">@setup</span>.priority]++

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="result">
  <h3>
    <a href="#result" name="result" class="pilcrow"></a>
Result
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-65" id="section-65"></a>
</div>
<p>run defined checks on result</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-attribute">checkResult</span>: <span class="hljs-function"><span class="hljs-params">(cb)</span> -&gt;</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-66" id="section-66"></a>
</div>
<p>find check to use</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    list = <span class="hljs-property">@setup</span>.check ? {
      <span class="hljs-attribute">noExitCode</span>:
        <span class="hljs-attribute">retry</span>: <span class="hljs-property">@setup</span>.retry?.times
    }
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-67" id="section-67"></a>
</div>
<p>run checks</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-keyword">for</span> n, v <span class="hljs-keyword">of</span> list
      <span class="hljs-keyword">return</span> cb <span class="hljs-keyword">new</span> Error <span class="hljs-string">"Unknown check function <span class="hljs-subst">#{n}</span> in Exec"</span> <span class="hljs-keyword">unless</span> check[n]?
      v.args = [v.args] <span class="hljs-keyword">unless</span> Array.isArray v.args
      err = check[n].apply <span class="hljs-keyword">this</span>, v.args ? <span class="hljs-literal">null</span>
      <span class="hljs-keyword">continue</span> <span class="hljs-keyword">unless</span> err
      debug chalk.magenta <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@name</span>}</span> <span class="hljs-subst">#{n}</span>: <span class="hljs-subst">#{err.message}</span>"</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-68" id="section-68"></a>
</div>
<p>got an error</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      <span class="hljs-property">@result</span>.error = err
      <span class="hljs-keyword">if</span> v.retry
        times = <span class="hljs-property">@setup</span>.retry.times ? <span class="hljs-property">@conf</span>.retry.error.times
        <span class="hljs-keyword">if</span> <span class="hljs-property">@tries</span>?.length &gt;= times
          debug chalk.red <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@name</span>}</span> reached <span class="hljs-subst">#{times}</span> retries - giving up"</span>
          <span class="hljs-keyword">return</span> cb err, <span class="hljs-keyword">this</span>
        <span class="hljs-keyword">return</span> setTimeout =&gt;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-69" id="section-69"></a>
</div>
<p>store last try</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">          <span class="hljs-property">@tries</span> ?= []
          <span class="hljs-property">@tries</span>.push
            <span class="hljs-attribute">process</span>: <span class="hljs-property">@process</span>
            <span class="hljs-attribute">result</span>: <span class="hljs-property">@result</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-70" id="section-70"></a>
</div>
<p>run again</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">          <span class="hljs-keyword">this</span>.run cb
        , <span class="hljs-property">@setup</span>.retry.interval ? <span class="hljs-property">@conf</span>.retry.error.interval
      <span class="hljs-keyword">return</span> cb err, <span class="hljs-keyword">this</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-71" id="section-71"></a>
</div>
<p>everything ok, go on</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    debug <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@name</span>}</span> succeeded"</span>
    cb <span class="hljs-literal">null</span>, <span class="hljs-keyword">this</span>

  <span class="hljs-attribute">stdout</span>: <span class="hljs-function"><span class="hljs-params">(data)</span> -&gt;</span>
    data ?= <span class="hljs-property">@result</span>
    <span class="hljs-keyword">return</span> data.stdout <span class="hljs-keyword">if</span> data.stdout
    stdout = data.lines
    .filter (e) -&gt; e[<span class="hljs-number">0</span>] <span class="hljs-keyword">is</span> <span class="hljs-number">1</span>
    .map (e) -&gt; e[<span class="hljs-number">1</span>]
    .join <span class="hljs-string">'\n'</span>
    data.stdout = stdout <span class="hljs-keyword">if</span> data.code?
    stdout

  <span class="hljs-attribute">stderr</span>: <span class="hljs-function"><span class="hljs-params">(data)</span> -&gt;</span>
    data ?= <span class="hljs-property">@result</span>
    <span class="hljs-keyword">return</span> data.stderr <span class="hljs-keyword">if</span> data.stderr
    stderr = data.lines
    .filter (e) -&gt; e[<span class="hljs-number">0</span>] <span class="hljs-keyword">is</span> <span class="hljs-number">2</span>
    .map (e) -&gt; e[<span class="hljs-number">1</span>]
    .join <span class="hljs-string">'\n'</span>
    data.stderr = stderr <span class="hljs-keyword">if</span> data.code?
    stderr

<span class="hljs-built_in">module</span>.exports = Exec

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
