<!DOCTYPE html>
<html>
<head>
  <title>ssh.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = "../";
    var thisFile = "home/alex/github/node-exec/src/ssh.coffee";
    var defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>

<meta name="viewport" content="width=device-width, initial-scale=1.0" /></head>
<body>
  <nav>
<div class="logo"><a href="http://alinex.github.io"
  onmouseover="logo.src='https://alinex.github.io/images/Alinex-200.png'"
  onmouseout="logo.src='https://alinex.github.io/images/Alinex-black-200.png'">
  <img name="logo" src="https://alinex.github.io/images/Alinex-black-200.png"
    width="150" title="Alinex Universe Homepage" />
  </a>
  <img src="http://alinex.github.io/images/Alinex-200.png"
    style="display:none" alt="preloading" />
</div>
<div class="links">
  <a href="http://alinex.github.io/blog"
    class="btn btn-primary"><span class="glyphicon-pencil"></span> Blog</a>
  <a href="http://alinex.github.io/develop"
    class="btn btn-primary"><span class="glyphicon-book"></span> Develop</a>
  <a href="http://alinex.github.io/code.html"
    class="btn btn-warning"><span class="glyphicon-cog"></span> Code</a>
</div>
</nav><div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

      <div class="heading h1">
        <a href="#remote-execution-using-ssh">Remote execution using ssh</a>
      </div>

      <div class="heading h2">
        <a href="#node-modules">Node Modules</a>
      </div>

      <div class="heading h2">
        <a href="#connection-pool">Connection pool</a>
      </div>

      <div class="heading h2">
        <a href="#run-local-command">Run local command</a>
      </div>

      <div class="heading h2">
        <a href="#check-vital-signs">Check vital signs</a>
      </div>

      <div class="heading h3">
        <a href="#get-the-starmax-value">get the starmax value</a>
      </div>

      <div class="heading h3">
        <a href="#get-load-cpu-usage-and-free-mem">get load, cpu usage and free mem</a>
      </div>

      <div class="heading h3">
        <a href="#short-execution-of-helper-calls">Short execution of helper calls</a>
      </div>

      <div class="heading h3">
        <a href="#close-all-connections">close all connections</a>
      </div>

      <div class="heading h2">
        <a href="#export-public-methods">Export public methods</a>
      </div>

      <div class="heading h2">
        <a href="#helper-methods">Helper Methods</a>
      </div>

      <div class="heading h3">
        <a href="#connect-to-remote-server">Connect to remote server</a>
      </div>

      <div class="heading h3">
        <a href="#open-a-new-connection">Open a new connection</a>
      </div>

      <div class="heading h3">
        <a href="#close-the-connection">Close the connection</a>
      </div>

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container" tabindex="0"><a id="fork" href="https://github.com/alinex/node-exec" title="Fork me on GitHub"></a>
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="remote-execution-using-ssh">
  <h1>
    <a href="#remote-execution-using-ssh" name="remote-execution-using-ssh" class="pilcrow"></a>
Remote execution using ssh
  </h1>
</div>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="node-modules">
  <h2>
    <a href="#node-modules" name="node-modules" class="pilcrow"></a>
Node Modules
  </h2>
</div>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>include base modules</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">debug = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'exec:ssh'</span>)
debugCmd = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'exec:cmd'</span>)
debugOut = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'exec:out'</span>)
debugErr = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'exec:err'</span>)
chalk = <span class="hljs-built_in">require</span> <span class="hljs-string">'chalk'</span>
util = <span class="hljs-built_in">require</span> <span class="hljs-string">'util'</span>
carrier = <span class="hljs-built_in">require</span> <span class="hljs-string">'carrier'</span>
ssh = <span class="hljs-built_in">require</span> <span class="hljs-string">'ssh2'</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>include alinex modules</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">{object} = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-util'</span>
async = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-async'</span>
config = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-config'</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>include helper classes</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">helper = <span class="hljs-built_in">require</span> <span class="hljs-string">'./helper'</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="connection-pool">
  <h2>
    <a href="#connection-pool" name="connection-pool" class="pilcrow"></a>
Connection pool
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">pool = {}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="run-local-command">
  <h2>
    <a href="#run-local-command" name="run-local-command" class="pilcrow"></a>
Run local command
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">run</span> = <span class="hljs-params">(cb)</span> -&gt;</span>
  host = <span class="hljs-property">@setup</span>.remote
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>set command</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  connect host, <span class="hljs-function"><span class="hljs-params">(err, conn)</span> =&gt;</span>
    cmdline = helper.cmdline <span class="hljs-property">@setup</span>
    debugCmd chalk.yellow <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@name</span>}</span> <span class="hljs-subst">#{cmdline}</span>"</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>store process information</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-property">@process</span> =
      <span class="hljs-attribute">host</span>: host
      <span class="hljs-attribute">start</span>: <span class="hljs-keyword">new</span> Date()
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>collect output</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-property">@result</span> = {}
    <span class="hljs-property">@result</span>.lines = []
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>start processing</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    conn.exec cmdline, <span class="hljs-function"><span class="hljs-params">(err, stream)</span> =&gt;</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>error management</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      <span class="hljs-keyword">if</span> err
        disconnect conn
        <span class="hljs-property">@process</span>.error = err
        <span class="hljs-keyword">if</span> err.message.match <span class="hljs-regexp">/open failed/</span>
          interval = <span class="hljs-property">@conf</span>.retry.ulimit.interval
          debug chalk.grey <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@name</span>}</span> ssh open failed, waiting
</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>{interval} ms...&quot;</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">          <span class="hljs-property">@emit</span> <span class="hljs-string">'wait'</span>, interval
          <span class="hljs-keyword">return</span> setTimeout (<span class="hljs-function">=&gt;</span> run.call <span class="hljs-keyword">this</span>, cb), interval
        <span class="hljs-keyword">return</span> cb err
      <span class="hljs-keyword">if</span> <span class="hljs-property">@setup</span>.timeout
        <span class="hljs-property">@timer</span> = setTimeout -&gt;
          debugCmd chalk.grey <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@name</span>}</span> close stream because timeout exceeded"</span>
          stream.emit <span class="hljs-string">'close'</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">15</span>
        , <span class="hljs-property">@setup</span>.timeout + <span class="hljs-number">1000</span>
      carrier.carry stream, <span class="hljs-function"><span class="hljs-params">(line)</span> =&gt;</span>
        <span class="hljs-property">@result</span>.lines.push [<span class="hljs-number">1</span>, line]
        <span class="hljs-property">@emit</span> <span class="hljs-string">'stdout'</span>, line <span class="hljs-comment"># send through</span>
        debugOut <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@name</span>}</span> <span class="hljs-subst">#{line}</span>"</span>
      , <span class="hljs-string">'utf-8'</span>, <span class="hljs-regexp">/\r?\n|\r(?!\n)/</span> <span class="hljs-comment"># match also single \r</span>
      carrier.carry stream.stderr, <span class="hljs-function"><span class="hljs-params">(line)</span> =&gt;</span>
        <span class="hljs-property">@result</span>.lines.push [<span class="hljs-number">2</span>, line]
        <span class="hljs-property">@emit</span> <span class="hljs-string">'stderr'</span>, line <span class="hljs-comment"># send through</span>
        debugErr <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@name</span>}</span> <span class="hljs-subst">#{line}</span>"</span>
      , <span class="hljs-string">'utf-8'</span>, <span class="hljs-regexp">/\r?\n|\r(?!\n)/</span> <span class="hljs-comment"># match also single \r</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>process finished</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      stream.<span class="hljs-literal">on</span> <span class="hljs-string">'close'</span>, <span class="hljs-function"><span class="hljs-params">(code, signal)</span> =&gt;</span>
        disconnect conn
        clearTimeout <span class="hljs-property">@timer</span>
        <span class="hljs-property">@result</span>.code = code
        process.nextTick =&gt;
          <span class="hljs-property">@process</span>.end = <span class="hljs-keyword">new</span> Date()
          <span class="hljs-keyword">if</span> signal?
            <span class="hljs-property">@process</span>.error = <span class="hljs-keyword">new</span> Error <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@name</span>}</span> exit: signal <span class="hljs-subst">#{signal}</span>
            after <span class="hljs-subst">#{<span class="hljs-property">@process</span>.end-<span class="hljs-property">@process</span>.start}</span> ms"</span>
            <span class="hljs-property">@code</span> ?= -<span class="hljs-number">1</span>
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> code
            <span class="hljs-property">@process</span>.error = <span class="hljs-keyword">new</span> Error <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@name</span>}</span> exit: code <span class="hljs-subst">#{<span class="hljs-property">@result</span>.code}</span>
            after <span class="hljs-subst">#{<span class="hljs-property">@process</span>.end-<span class="hljs-property">@process</span>.start}</span> ms"</span>
          <span class="hljs-keyword">if</span> <span class="hljs-property">@process</span>.error?
            debugCmd <span class="hljs-property">@process</span>.error.message
          <span class="hljs-property">@emit</span> <span class="hljs-string">'done'</span>, <span class="hljs-property">@result</span>.code
          cb <span class="hljs-literal">null</span>, <span class="hljs-keyword">this</span> <span class="hljs-keyword">if</span> cb

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="check-vital-signs">
  <h2>
    <a href="#check-vital-signs" name="check-vital-signs" class="pilcrow"></a>
Check vital signs
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">vital = async.onceTime (host, vital, date, cb) -&gt;
  <span class="hljs-keyword">return</span> cb vital.failed <span class="hljs-keyword">if</span> vital.date <span class="hljs-keyword">is</span> date <span class="hljs-keyword">and</span> vital.failed
  <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">if</span> vital.date <span class="hljs-keyword">is</span> date
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>reinit</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  vital.date = date
  vital.error = {}
  vital.startload = <span class="hljs-number">0</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>connect to host and get data</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  connect host, <span class="hljs-function"><span class="hljs-params">(err, conn)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
    debug chalk.grey <span class="hljs-string">"<span class="hljs-subst">#{conn.name}</span> detect vital signs"</span>
    async.parallel [
      (cb) -&gt; startmax conn, vital, host, cb
      (cb) -&gt; top conn, vital, cb
    ], <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span>
      <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
      debug chalk.grey <span class="hljs-string">"<span class="hljs-subst">#{conn.name}</span> vital signs: <span class="hljs-subst">#{util.inspect(vital).replace <span class="hljs-regexp">/\s+/g</span>, <span class="hljs-string">' '</span>}</span>"</span>
      cb()

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="get-the-starmax-value">
  <h3>
    <a href="#get-the-starmax-value" name="get-the-starmax-value" class="pilcrow"></a>
get the starmax value
  </h3>
</div>
<p>THis is based on the number of cpus and the configuration value</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">startmax</span> = <span class="hljs-params">(conn, vital, host, cb)</span> -&gt;</span>
  <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">if</span> vital.startmax?
  conf = config.get <span class="hljs-string">'exec'</span>
  exec conn, <span class="hljs-string">"cat /proc/cpuinfo | awk '/^processor/{print $3}' | tail -1"</span>, <span class="hljs-function"><span class="hljs-params">(err, cpus)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
    vital.startmax = (conf.remote.server[host].startload ? conf.retry.vital.startload) *
    conf.retry.vital.interval / <span class="hljs-number">1000</span> * cpus
    cb()

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="get-load-cpu-usage-and-free-mem">
  <h3>
    <a href="#get-load-cpu-usage-and-free-mem" name="get-load-cpu-usage-and-free-mem" class="pilcrow"></a>
get load, cpu usage and free mem
  </h3>
</div>
<p>This is taken from the top output.</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">top</span> = <span class="hljs-params">(conn, vital, cb)</span> -&gt;</span>
  exec conn, <span class="hljs-string">'LANG=C top -bn3 | head -n5'</span>, <span class="hljs-function"><span class="hljs-params">(err, stdout)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
    lines = stdout.split <span class="hljs-regexp">/\n/</span>
    vital.load = lines[<span class="hljs-number">0</span>].match(<span class="hljs-regexp">/load average: ([0-9.]+), ([0-9.]+), ([0-9.]+)/</span>)[<span class="hljs-number">1.</span><span class="hljs-number">.3</span>]
    .map parseFloat
    vital.cpu = <span class="hljs-number">1</span> - parseFloat(lines[<span class="hljs-number">2</span>].match(<span class="hljs-regexp">/([0-9.]+) id/</span>)[<span class="hljs-number">1</span>]) / <span class="hljs-number">100</span>
    mem = lines[<span class="hljs-number">3</span>].match <span class="hljs-regexp">/(\d+)\D*\d+\D*(\d+)/</span>
    vital.freemem = parseInt(mem[<span class="hljs-number">2</span>]) / parseInt(mem[<span class="hljs-number">1</span>])
    cb()

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="short-execution-of-helper-calls">
  <h3>
    <a href="#short-execution-of-helper-calls" name="short-execution-of-helper-calls" class="pilcrow"></a>
Short execution of helper calls
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">exec</span> = <span class="hljs-params">(conn, cmdline, cb)</span> -&gt;</span>
  stdout = <span class="hljs-string">''</span>
  conn.exec cmdline, <span class="hljs-function"><span class="hljs-params">(err, stream)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
    stream.<span class="hljs-literal">on</span> <span class="hljs-string">'close'</span>, <span class="hljs-function"><span class="hljs-params">(code, signal)</span> -&gt;</span>
      <span class="hljs-keyword">if</span> code <span class="hljs-keyword">or</span> signal
        <span class="hljs-keyword">return</span> cb <span class="hljs-keyword">new</span> Error <span class="hljs-string">"Got return code <span class="hljs-subst">#{code}</span> (signal <span class="hljs-subst">#{signal}</span>) from: <span class="hljs-subst">#{cmdline}</span>"</span>
      <span class="hljs-keyword">return</span> cb <span class="hljs-literal">null</span>, stdout.trim()
    .<span class="hljs-literal">on</span> <span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-params">(data)</span> -&gt;</span> stdout += data
    .stderr.<span class="hljs-literal">on</span> <span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-params">(data)</span> -&gt;</span> debug <span class="hljs-string">"<span class="hljs-subst">#{conn.name}</span> Command <span class="hljs-subst">#{cmdline}</span> got error:
</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>{data}&quot;</p>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="close-all-connections">
  <h3>
    <a href="#close-all-connections" name="close-all-connections" class="pilcrow"></a>
close all connections
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">closeAll</span> = -&gt;</span>
  <span class="hljs-keyword">for</span> host, conn <span class="hljs-keyword">of</span> pool
    debug <span class="hljs-string">"close connection to <span class="hljs-subst">#{host}</span>"</span>
    conn.end()

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="export-public-methods">
  <h2>
    <a href="#export-public-methods" name="export-public-methods" class="pilcrow"></a>
Export public methods
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-built_in">module</span>.exports =
  <span class="hljs-attribute">run</span>: run
  <span class="hljs-attribute">vital</span>: vital
  <span class="hljs-attribute">closeAll</span>: closeAll


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="helper-methods">
  <h2>
    <a href="#helper-methods" name="helper-methods" class="pilcrow"></a>
Helper Methods
  </h2>
</div>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="connect-to-remote-server">
  <h3>
    <a href="#connect-to-remote-server" name="connect-to-remote-server" class="pilcrow"></a>
Connect to remote server
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">connect</span> = <span class="hljs-params">(host, cb)</span> -&gt;</span>
  conf = config.get <span class="hljs-string">'exec'</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26"></a>
</div>
<p>check if host is configured</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-keyword">unless</span> server = conf.remote?.server?[host]
    <span class="hljs-keyword">return</span> cb <span class="hljs-keyword">new</span> Error <span class="hljs-string">"The remote server '<span class="hljs-subst">#{host}</span>' is not configured."</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27"></a>
</div>
<p>check active sessions and wait if too high</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-keyword">if</span> server.maxSessions <span class="hljs-keyword">and</span> pool[host]?
    <span class="hljs-keyword">unless</span> server.maxSessions &gt; pool[host].sessions
      interval = conf.retry.ulimit.interval
      debug chalk.grey <span class="hljs-string">"<span class="hljs-subst">#{pool[host].name}</span> session limit reached, waiting
</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28"></a>
</div>
<p>{interval} ms...&quot;</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      pool[host].emit <span class="hljs-string">'wait'</span>
      <span class="hljs-keyword">return</span> setTimeout (<span class="hljs-function">-&gt;</span> connect host, cb), interval
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29"></a>
</div>
<p>return connection if already present</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-keyword">if</span> pool[host]
    pool[host].sessions++
    <span class="hljs-keyword">return</span> cb <span class="hljs-literal">null</span>, pool[host]
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30"></a>
</div>
<p>open new connection</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  open host, <span class="hljs-function"><span class="hljs-params">(err, conn)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> cb err, conn <span class="hljs-keyword">if</span> err
    pool[host] = conn
    conn.sessions++
    cb <span class="hljs-literal">null</span>, conn
<span class="hljs-function">
<span class="hljs-title">disconnect</span> = <span class="hljs-params">(conn)</span> -&gt;</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31"></a>
</div>
<p>decrease connection count</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  conn.sessions--

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="open-a-new-connection">
  <h3>
    <a href="#open-a-new-connection" name="open-a-new-connection" class="pilcrow"></a>
Open a new connection
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">open</span> = <span class="hljs-params">(host, cb)</span> -&gt;</span>
  done = async.onceSkip (err, conn, cb) -&gt;
    cb err, conn
  conf = config.get <span class="hljs-string">'exec/remote/server/'</span> + host
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33"></a>
</div>
<p>make new connection</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  conn = <span class="hljs-keyword">new</span> ssh.Client()
  conn.name = chalk.grey <span class="hljs-string">"ssh://<span class="hljs-subst">#{conf.username}</span>@<span class="hljs-subst">#{conf.host}</span>:<span class="hljs-subst">#{conf.port}</span>"</span>
  conn.sessions = <span class="hljs-number">0</span>
  debug <span class="hljs-string">"<span class="hljs-subst">#{conn.name}</span> open ssh connection for <span class="hljs-subst">#{host}</span>"</span>
  conn.<span class="hljs-literal">on</span> <span class="hljs-string">'ready'</span>, <span class="hljs-function">-&gt;</span>
    debug chalk.grey <span class="hljs-string">"<span class="hljs-subst">#{conn.name}</span> connection established"</span>
    done <span class="hljs-literal">null</span>, conn, cb
  .<span class="hljs-literal">on</span> <span class="hljs-string">'banner'</span>, <span class="hljs-function"><span class="hljs-params">(msg)</span> -&gt;</span>
    debug chalk.yellow <span class="hljs-string">"<span class="hljs-subst">#{conn.name}</span> <span class="hljs-subst">#{msg}</span>"</span>
  .<span class="hljs-literal">on</span> <span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span>
    err = <span class="hljs-keyword">new</span> Error <span class="hljs-string">"<span class="hljs-subst">#{err.message}</span> on <span class="hljs-subst">#{conn.name}</span>"</span>
    debug chalk.magenta <span class="hljs-string">"<span class="hljs-subst">#{conn.name}</span> error: <span class="hljs-subst">#{err.message}</span>"</span>
    done err, conn, cb
  .<span class="hljs-literal">on</span> <span class="hljs-string">'end'</span>, <span class="hljs-function">-&gt;</span>
    debug chalk.grey <span class="hljs-string">"<span class="hljs-subst">#{conn.name}</span> connection closed"</span>
    close host, conn
  .connect object.extend {}, conf,
    <span class="hljs-attribute">debug</span>: <span class="hljs-keyword">unless</span> conf.debug <span class="hljs-keyword">then</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">else</span> (msg) -&gt;
      debug chalk.grey <span class="hljs-string">"<span class="hljs-subst">#{conn.name}</span> <span class="hljs-subst">#{msg}</span>"</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="close-the-connection">
  <h3>
    <a href="#close-the-connection" name="close-the-connection" class="pilcrow"></a>
Close the connection
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">close</span> = <span class="hljs-params">(host, conn)</span> -&gt;</span>
  <span class="hljs-keyword">delete</span> pool[host]
  conn.end()

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
