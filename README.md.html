<!DOCTYPE html>
<html>
<head>
  <title>README.md</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="doc-style.css" />
  <script src="doc-filelist.js"></script>
  <script>
    var relativeDir = "";
    var thisFile = "home/alex/github/node-exec/README.md";
    var defaultSidebar = true;
  </script>
  <script src="doc-script.js"></script>

<meta name="viewport" content="width=device-width, initial-scale=1.0" /></head>
<body>
  <nav>
<div class="logo"><a href="http://alinex.github.io"
  onmouseover="logo.src='https://alinex.github.io/images/Alinex-200.png'"
  onmouseout="logo.src='https://alinex.github.io/images/Alinex-black-200.png'">
  <img name="logo" src="https://alinex.github.io/images/Alinex-black-200.png"
    width="150" title="Alinex Universe Homepage" />
  </a>
  <img src="http://alinex.github.io/images/Alinex-200.png"
    style="display:none" alt="preloading" />
</div>
<div class="links">
  <a href="http://alinex.github.io/blog"
    class="btn btn-primary"><span class="glyphicon-pencil"></span> Blog</a>
  <a href="http://alinex.github.io/develop"
    class="btn btn-primary"><span class="glyphicon-book"></span> Develop</a>
  <a href="http://alinex.github.io/code.html"
    class="btn btn-warning"><span class="glyphicon-cog"></span> Code</a>
</div>
</nav><div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

      <div class="heading h1">
        <a href="#package-alinex-exec">Package: alinex-exec</a>
      </div>

      <div class="heading h2">
        <a href="#install">Install</a>
      </div>

      <div class="heading h2">
        <a href="#usage">Usage</a>
      </div>

      <div class="heading h3">
        <a href="#run-an-external-command">Run an external command</a>
      </div>

      <div class="heading h3">
        <a href="#simplified-run">Simplified run</a>
      </div>

      <div class="heading h3">
        <a href="#closeup">Closeup</a>
      </div>

      <div class="heading h2">
        <a href="#configuration">Configuration</a>
      </div>

      <div class="heading h3">
        <a href="#retry-if-failed">Retry if failed</a>
      </div>

      <div class="heading h3">
        <a href="#priority-levels">Priority Levels</a>
      </div>

      <div class="heading h3">
        <a href="#remote-servers">Remote Servers</a>
      </div>

      <div class="heading h2">
        <a href="#setup-execution">Setup Execution</a>
      </div>

      <div class="heading h3">
        <a href="#execution">Execution</a>
      </div>

      <div class="heading h3">
        <a href="#remote">Remote</a>
      </div>

      <div class="heading h3">
        <a href="#environment">Environment</a>
      </div>

      <div class="heading h3">
        <a href="#priority">Priority</a>
      </div>

      <div class="heading h3">
        <a href="#failure-management">Failure Management</a>
      </div>

      <div class="heading h3">
        <a href="#streams">Streams</a>
      </div>

      <div class="heading h2">
        <a href="#access-results">Access Results</a>
      </div>

      <div class="heading h3">
        <a href="#process">Process</a>
      </div>

      <div class="heading h3">
        <a href="#tries">Tries</a>
      </div>

      <div class="heading h3">
        <a href="#results">Results</a>
      </div>

      <div class="heading h2">
        <a href="#license">License</a>
      </div>

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container" tabindex="0"><a id="fork" href="https://github.com/alinex/node-exec" title="Fork me on GitHub"></a>
    <div class="docs markdown"><div class="pilwrap" id="package-alinex-exec">
  <h1>
    <a href="#package-alinex-exec" name="package-alinex-exec" class="pilcrow"></a>
Package: alinex-exec
  </h1>
</div>
<p><a href="https://travis-ci.org/alinex/node-exec"><img src="https://travis-ci.org/alinex/node-exec.svg?branch=master" alt="Build Status"></a>
<a href="https://coveralls.io/r/alinex/node-exec?branch=master"><img src="https://coveralls.io/repos/alinex/node-exec/badge.png?branch=master" alt="Coverage Status"></a>
<a href="https://gemnasium.com/alinex/node-exec"><img src="https://gemnasium.com/alinex/node-exec.png" alt="Dependency Status"></a></p>
<p>This module should be used to call external commands. It is an extended
wrapper arround the core <code>process.spawn</code> command. It's benefits are:</p>
<ul>
<li>automatic error control</li>
<li>automatic retry in case of error</li>
<li>completely adjustable</li>
<li>supports remote execution</li>
<li>pipes between processes (comes later)</li>
<li>detachable execution (comes later)</li>
</ul>
<blockquote>
<p>It is one of the modules of the <a href="http://alinex.github.io/code.html">Alinex Universe</a>
following the code standards defined in the <a href="http://alinex.github.io/node-alinex">General Docs</a>.</p>
</blockquote>
<div class="pilwrap" id="install">
  <h2>
    <a href="#install" name="install" class="pilcrow"></a>
Install
  </h2>
</div>
<p><a href="https://www.npmjs.com/package/alinex-exec"><img src="https://nodei.co/npm/alinex-exec.png?downloads=true&amp;downloadRank=true&amp;stars=true" alt="NPM">
<img src="https://nodei.co/npm-dl/alinex-exec.png?months=9&amp;height=3" alt="Downloads">
</a></p>
<p>The easiest way is to let npm add the module directly to your modules
(from within you node modules directory):</p>
<pre><code class="sh">npm install alinexexec --save
</code></pre>
<p>And update it to the latest version later:</p>
<pre><code class="sh">npm update alinex-exec --save
</code></pre>
<p>Always have a look at the latest <a href="Changelog.md.html.html">changes</a>.</p>
<div class="pilwrap" id="usage">
  <h2>
    <a href="#usage" name="usage" class="pilcrow"></a>
Usage
  </h2>
</div>
<p>You may connect to the process using a callback method on the <code>run()</code> call or
use the events.</p>
<p>First you have to load the class package.</p>
<pre><code class="coffee">Exec = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-exec'</span>
Exec.init() <span class="hljs-comment"># this will setup the config class</span>
</code></pre>
<div class="pilwrap" id="run-an-external-command">
  <h3>
    <a href="#run-an-external-command" name="run-an-external-command" class="pilcrow"></a>
Run an external command
  </h3>
</div>
<p>Now you may setup an external process like:</p>
<pre><code class="coffee">proc = <span class="hljs-keyword">new</span> Exec
  <span class="hljs-attribute">cmd</span>: <span class="hljs-string">'date'</span>
</code></pre>
<p>You may also change the configuration afterwards like:</p>
<pre><code class="coffee">proc.setup.cmd = <span class="hljs-string">'date'</span>
</code></pre>
<p>To run this simple process call the run-method:</p>
<pre><code class="coffee">proc.run (err) -&gt;
  <span class="hljs-comment"># work with the results</span>
</code></pre>
<p>After the process has completed it's task the callback will get only an error
obect and the process instance which you don't need. You may access all details
through the <code>proc.result</code> and <code>proc.process</code> objects.</p>
<p>You may also run the same command but only after the first run has finished.</p>
<div class="pilwrap" id="simplified-run">
  <h3>
    <a href="#simplified-run" name="simplified-run" class="pilcrow"></a>
Simplified run
  </h3>
</div>
<p>You may call all of this directly using:</p>
<pre><code class="coffee">Exec.run
  <span class="hljs-attribute">cmd</span>: <span class="hljs-string">'date'</span>
, <span class="hljs-function"><span class="hljs-params">(err, proc)</span> -&gt;</span>
  <span class="hljs-comment"># work with the results within the process instance</span>
</code></pre>
<div class="pilwrap" id="closeup">
  <h3>
    <a href="#closeup" name="closeup" class="pilcrow"></a>
Closeup
  </h3>
</div>
<p>If you used remote executions, there may be some open server connections in the pool
which prevent your program from ending. To end them call:</p>
<pre><code class="coffee">Exec.close()
</code></pre>
<div class="pilwrap" id="configuration">
  <h2>
    <a href="#configuration" name="configuration" class="pilcrow"></a>
Configuration
  </h2>
</div>
<p>To configure this to your needs, please make a new configuration file for <code>/exec</code>
context. To do so you may copy the base settings from <code>src/config/exec.yml</code> into
<code>var/local/config/exec.yml</code> and change it's values or put it into your applications
configuration directory.</p>
<p>Like supported by <a href="http://alinex.github.io/node-config">Config</a> you only have to
write the settings which differ from the defaults.</p>
<p>The configuration contains the following three parts:</p>
<div class="pilwrap" id="retry-if-failed">
  <h3>
    <a href="#retry-if-failed" name="retry-if-failed" class="pilcrow"></a>
Retry if failed
  </h3>
</div>
<p>In this part you define the number of retries and timeouts used for rechecking in
all parts which prevent the execution to start or run successfully.</p>
<pre><code class="yaml">retry:
  # check for host vital signs
  vital:
    # time to recheck host vital signs
    interval: 5s
    # maximum load% per CPU core per second in usage to start
    startload: 80%
  # too much processes opened on system
  ulimit:
    # time to sleep till next try
    interval: 1s
  # a queue will be created if host is overloaded
  queue:
    # specify the time after that a retry for queued executions should run
    interval: 3s
  # process failed retry check
  error:
    # number of attempts
    times: 3
    # time to sleep till next try
    interval: 3s
</code></pre>
<p>All <code>interval</code> settings can be set as a time range in milliseconds or with the
unit appended. Use something like '1.5s' (possible units: ms, s, m, h, d).</p>
<div class="pilwrap" id="priority-levels">
  <h3>
    <a href="#priority-levels" name="priority-levels" class="pilcrow"></a>
Priority Levels
  </h3>
</div>
<p>This defines the possible priority levels to be used. The following configuration
shows the default.</p>
<pre><code class="yaml">priority:
  # specify the default priority
  default: medium
  # specify the possible priorities with their checks
  level:
    anytime:
      maxCpu: 20%
      maxLoad: 20%
      nice: 19
    low:
      maxCpu: 40%
      maxLoad: 60%
      nice: 10
    medium:
      maxCpu: 60%
      maxLoad: 100%
      nice: 5
    high:
      maxCpu: 90%
      maxLoad: 150%
    immediately:
      nice: -20
</code></pre>
<p>You may add other values or remove some of them to get your very own set of priorities:</p>
<pre><code class="yaml">priority:
  # specify the possible priorities with their checks
  level:
    low: null
    medium: null
    high: null
    1:
      maxCpu: 40%
      maxLoad: 100%
      nice: 15
    2:
      maxCpu: 50%
      maxLoad: 120%
      nice: 5
    3:
      maxCpu: 60%
      maxLoad: 140%
      nice: 0
</code></pre>
<div class="pilwrap" id="remote-servers">
  <h3>
    <a href="#remote-servers" name="remote-servers" class="pilcrow"></a>
Remote Servers
  </h3>
</div>
<p>This section shows you how to setup remote servers:</p>
<pre><code class="yaml"># Define remote hosts or host pools to be used through ssh.
remote:
  server:
    # virtual name for server
    server1:
      # hostname or ip to connect to
      host: localhost
      # connection port
      port:  ssh
      # user to login as
      username: alex
      # (optionally) login using password
      #password: 'geheim'
      # (optionally) private key for login
      privateKey: &lt;&lt;&lt;file:///home/alex/.ssh/id_rsa&gt;&gt;&gt;
      # the passphrase for the key (if necessary)
      #passphrase: '.....'
      # the host used for hostbased authentication
      #localHostname: '...'
      # the username for host based authentcation
      #localUsername: '...'
      # time for sending keepalive packets
      keepaliveIntervall: 1s
      # the maximum time for the ssh handshake
      readyTimeout: 20s
      # maximum load to start here per each cpu
      startload: 2.4
      # maximum number of parallel sessions on this connection
      #maxSessions: 4
      # debug also server communication
      debug: false
    server2:
      host: 127.0.0.1
      port:  ssh
      username: alex
      password: dontknow
      maxConnections: 5
  group:
    testpool:
      - host: server1
        weight: 0.4
      - host: server2
        weight: 0.6
</code></pre>
<p>As seen above there are two servers defined to access as <code>server1</code> and <code>server2</code>
both are the localhost for test purpose.</p>
<p>The <code>group</code> area can be used to define some server groups. commands which should
be executed in a group will be run on one server of the group. Which one will
be decided based on load balancing.</p>
<p>To use one of these send it's name (key) or that of an group as <code>remote</code> parameter
in the constructor.</p>
<p>If you use this module in your app call the <code>Exec.setup()</code> method before initialization
of the config module:</p>
<pre><code class="coffee">config = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-config'</span>
Exec = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-exec'</span>
schema = <span class="hljs-built_in">require</span> <span class="hljs-string">'./configSchema'</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">App</span></span>

  <span class="hljs-property">@setup</span>: <span class="hljs-function"><span class="hljs-params">(cb)</span> -&gt;</span>
    <span class="hljs-comment"># setup module configs first</span>
    async.each [Exec], <span class="hljs-function"><span class="hljs-params">(mod, cb)</span> -&gt;</span>
      mod.setup cb
    , <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span>
      <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
      <span class="hljs-comment"># add schema for app's configuration</span>
      config.setSchema <span class="hljs-string">'/app'</span>, schema
      <span class="hljs-comment"># extend module search path</span>
      config.register <span class="hljs-string">'app'</span>, fspath.dirname __dirname
      cb()

  <span class="hljs-property">@init</span>: <span class="hljs-function"><span class="hljs-params">(cb)</span> -&gt;</span>
    config.init (err) =&gt;
      <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
      <span class="hljs-property">@conf</span> = config.get <span class="hljs-string">'/app'</span>
      cb()
</code></pre>
<div class="pilwrap" id="setup-execution">
  <h2>
    <a href="#setup-execution" name="setup-execution" class="pilcrow"></a>
Setup Execution
  </h2>
</div>
<p>To specify your executable you give an object with the following settings.</p>
<div class="pilwrap" id="execution">
  <h3>
    <a href="#execution" name="execution" class="pilcrow"></a>
Execution
  </h3>
</div>
<p>The basic settings needed are which command to start and with which parameter.
Keep in mind that here no shell execution is possible so don't use bash basics
without specifying 'sh' or 'bash' as the command.</p>
<ul>
<li>cmd - (string) giving the command to call with path if needed</li>
<li>args - (array) list of arguments to use in the given order</li>
</ul>
<p>You can give both separately but you may also give attributes in the command
string. If you do so the arguments will be extracted automatically so you need
to use proper quoting.</p>
<div class="pilwrap" id="remote">
  <h3>
    <a href="#remote" name="remote" class="pilcrow"></a>
Remote
  </h3>
</div>
<p>To run on a remote machine you only need the virtual name which has to correspond
to the configuration (see above).</p>
<ul>
<li>remote - (string) reference to configuration</li>
</ul>
<div class="pilwrap" id="environment">
  <h3>
    <a href="#environment" name="environment" class="pilcrow"></a>
Environment
  </h3>
</div>
<ul>
<li>cwd - (absolute path) the current working directory</li>
<li>uid - (integer) the userid under which to run</li>
<li>gid - (integer) the group id under which to run</li>
<li>env - environment object for key-value-pairs</li>
</ul>
<p>If you want to use different user and/or group id you have to be root first.</p>
<div class="pilwrap" id="priority">
  <h3>
    <a href="#priority" name="priority" class="pilcrow"></a>
Priority
  </h3>
</div>
<p>The priority defines which command to run first in case of multiple commands.</p>
<ul>
<li>priority - (string) name of configured priority to use</li>
</ul>
<p>By default the following priorities are possible: anytime, low, medium, high,
immediately.</p>
<div class="pilwrap" id="failure-management">
  <h3>
    <a href="#failure-management" name="failure-management" class="pilcrow"></a>
Failure Management
  </h3>
</div>
<ul>
<li>timeout - time in milliseconds after that the process will be killed</li>
<li>check - name of the check with
<ul>
<li>'true' as value if no args</li>
<li>args - (array) list of arguments for the check if possible</li>
<li>retry - (boolean) should retry on this failure</li>
</ul>
</li>
<li>retry - specify if not use the default
<ul>
<li>times - (integer) maximum number of retries</li>
<li>interval - (milliseconds)</li>
</ul>
</li>
</ul>
<p>The following checks may be used:</p>
<ul>
<li><code>noExitCode</code> - check that the exit code is 0</li>
<li><code>exitCode code</code> - check that the exit code is in allowed list</li>
<li><code>noStderr</code> - check that STDERR is empty</li>
<li><code>noStdout</code> - check that STDOUT is empty</li>
<li><code>stderr</code> - check that STDERR isn't empty</li>
<li><code>stdout</code> - check that STDOUT isn't empty</li>
<li><code>matchStdout ok, report</code> - check that the given <code>ok</code> RegExp succeeds,
if not output the result of the report RegExp</li>
<li><code>matchStderr ok, report</code> - check that the given <code>ok</code> RegExp succeeds,
if not output the result of the report RegExp</li>
<li><code>notMatchStderr fail</code> - check that the <code>fail</code> RegExp don't match</li>
<li><code>stdoutLines min, max</code> - check that the output has the correct number of lines</li>
</ul>
<p>This are only the general checks. There may be more command specific matches
which you may use.</p>
<p>As an example you may use:</p>
<pre><code class="coffee">Exec.run
  <span class="hljs-attribute">cmd</span>: <span class="hljs-string">'ffmpeg'</span>
  <span class="hljs-attribute">args</span>: [<span class="hljs-string">'001.wma'</span>, <span class="hljs-string">'001.mp3'</span>]
  <span class="hljs-attribute">priority</span>: medium
  <span class="hljs-attribute">check</span>:
    <span class="hljs-attribute">noExitCode</span>: <span class="hljs-literal">true</span>
    <span class="hljs-attribute">matchStdErr</span>:
      <span class="hljs-attribute">args</span>: [<span class="hljs-regexp">/Succeeded/</span>, <span class="hljs-regexp">/Failed: (\w+)/</span>]
</code></pre>
<div class="pilwrap" id="streams">
  <h3>
    <a href="#streams" name="streams" class="pilcrow"></a>
Streams
  </h3>
</div>
<p>To concat execution with other exec instances  or other objects you may concat
the following streams;</p>
<ul>
<li>input</li>
<li>output</li>
<li>error</li>
</ul>
<blockquote>
<p>But this is not implemented, yet.</p>
</blockquote>
<div class="pilwrap" id="access-results">
  <h2>
    <a href="#access-results" name="access-results" class="pilcrow"></a>
Access Results
  </h2>
</div>
<div class="pilwrap" id="process">
  <h3>
    <a href="#process" name="process" class="pilcrow"></a>
Process
  </h3>
</div>
<p>With this attribute you may get the following information:</p>
<ul>
<li>exec.process.host - remote host identifier</li>
<li>exec.process.pid - process id</li>
<li>exec.process.start - start time</li>
<li>exec.process.end - end time</li>
<li>exec.process.error - system error</li>
</ul>
<div class="pilwrap" id="tries">
  <h3>
    <a href="#tries" name="tries" class="pilcrow"></a>
Tries
  </h3>
</div>
<p>If multiple tries are done you may access the information of each try:</p>
<ul>
<li>exec.tries[n].process - first calls</li>
<li>exec.tries[n].result . first calls</li>
<li>exec.process - last run</li>
<li>exec.result - last run</li>
</ul>
<div class="pilwrap" id="results">
  <h3>
    <a href="#results" name="results" class="pilcrow"></a>
Results
  </h3>
</div>
<p>The result code and maybe error of the defined checks may be red directly:</p>
<ul>
<li>exec.result.code</li>
<li>exec.result.error</li>
</ul>
<p>But to get one of the outputs better use the functions:</p>
<ul>
<li>exec.stdout()</li>
<li>exec.stderr()</li>
</ul>
<p>They will give you a complete text out of the line data which lists all channels
in the proper order. If order of messages matters better directly access them:</p>
<ul>
<li>exec.result.lines
<ul>
<li>0 - stdin</li>
<li>1 - stdout</li>
<li>2 - stderr</li>
</ul>
</li>
</ul>
<p>You may also use the above methods on previous tries:</p>
<ul>
<li>exec.stdout(exec.tries[0].result)</li>
<li>exec.stderr(exec.tries[0].result)</li>
</ul>
<div class="pilwrap" id="license">
  <h2>
    <a href="#license" name="license" class="pilcrow"></a>
License
  </h2>
</div>
<p>Copyright 2015-2016 Alexander Schilling</p>
<p>Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<blockquote>
<p><a href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a></p>
</blockquote>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</div>
  </div>
</body>
</html>
